---
// src/pages/admin/index.astro - FIXED for Production
import { adminAuthManager } from "../../lib/admin/auth.js";

console.log("🔍 Admin Index - URL:", Astro.url.href);
console.log("🔍 Admin Index - Pathname:", Astro.url.pathname);
console.log("🔍 Admin Index - Search:", Astro.url.search);

// Initialize admin auth
try {
  await adminAuthManager.initialize();
} catch (error) {
  console.error("❌ Admin auth initialization failed:", error);
  return Astro.redirect("/auth/admin-signin?error=init_failed");
}

// Check admin status
const user = await adminAuthManager.getCurrentUser();

console.log("🔍 Admin Index - User check:", {
  hasUser: !!user,
  userEmail: user?.email,
  isAdmin: user?.isAdmin,
});

if (!user) {
  console.log("❌ No user found, redirecting to signin");
  const currentUrl = Astro.url.pathname + Astro.url.search;
  return Astro.redirect(
    `/auth/admin-signin?redirect=${encodeURIComponent(currentUrl)}`
  );
}

// Check if this is a direct TinaCMS access request
const searchParams = Astro.url.searchParams;
const accessTina =
  searchParams.get("cms") === "true" || searchParams.get("tina") === "true";

if (accessTina) {
  console.log("✅ TinaCMS access requested, redirecting directly");
  return Astro.redirect("/admin/index.html");
}

console.log("✅ User authenticated, redirecting to dashboard");
return Astro.redirect("/admin/dashboard");
---
