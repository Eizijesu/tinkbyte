---
// src/pages/profile/articles.astro - USER ARTICLES MANAGEMENT
import ProfileLayout from "../../layouts/ProfileLayout.astro";
import { supabase } from "../../lib/supabase";
import { AdminAPIManager } from "../../lib/admin-api";
---

<ProfileLayout
  title="My Articles | TinkByte"
  description="Manage your articles and create new content"
>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner">
      <div class="simple-spinner"></div>
      <span>Loading articles...</span>
    </div>
  </div>

  <!-- Error Banner -->
  <div id="error-banner" class="error-banner" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="error-message">An error occurred</span>
    <button class="retry-btn" id="retry-btn">
      <i class="fas fa-redo"></i>
      Retry
    </button>
  </div>

  <div class="articles-container">
    <!-- Articles Header -->
    <div class="articles-header">
      <div class="header-content">
        <h1>My Articles</h1>
        <p>Create and manage your articles</p>
      </div>
      <div class="header-actions">
        <button class="create-article-btn" id="create-article-btn">
          <span class="btn-spinner" id="create-spinner" style="display: none;">
            <div class="simple-spinner small"></div>
          </span>
          <i class="fas fa-plus"></i>
          Create Article
        </button>
      </div>
    </div>

    <!-- Articles Stats -->
    <div class="articles-stats-grid">
      <div class="stat-card primary">
        <div class="stat-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number" id="total-articles">-</div>
          <div class="stat-label">Total Articles</div>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">
          <i class="fas fa-eye"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number" id="published-articles">-</div>
          <div class="stat-label">Published</div>
        </div>
      </div>

      <div class="stat-card warning">
        <div class="stat-icon">
          <i class="fas fa-edit"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number" id="draft-articles">-</div>
          <div class="stat-label">Drafts</div>
        </div>
      </div>
    </div>

    <!-- Articles Grid -->
    <div id="articles-grid" class="articles-grid">
      <!-- Articles will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state" style="display: none;">
      <i class="fas fa-file-alt"></i>
      <h3>No articles yet</h3>
      <p>Start writing by creating your first article</p>
      <button class="create-first-article-btn" id="create-first-article">
        <i class="fas fa-plus"></i>
        Create First Article
      </button>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="pagination-container" style="display: none;">
      <!-- Pagination will be loaded here -->
    </div>

    <!-- Create/Edit Article Modal -->
    <div id="article-modal" class="modal" style="display: none;">
      <div class="modal-content large">
        <div class="modal-header">
          <h3 id="article-modal-title">Create Article</h3>
          <button class="modal-close" id="article-modal-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="article-form" class="article-form">
            <div class="form-row">
              <div class="form-group">
                <label for="article-title">Article Title *</label>
                <input
                  type="text"
                  id="article-title"
                  name="title"
                  required
                  placeholder="Enter article title"
                />
              </div>

              <div class="form-group">
                <label for="article-slug">URL Slug *</label>
                <input
                  type="text"
                  id="article-slug"
                  name="slug"
                  required
                  placeholder="article-url-slug"
                />
                <small class="form-help">Used in the article URL</small>
              </div>
            </div>

            <div class="form-group">
              <label for="article-subtitle">Subtitle</label>
              <input
                type="text"
                id="article-subtitle"
                name="subtitle"
                placeholder="Optional article subtitle"
              />
            </div>

            <div class="form-group">
              <label for="article-excerpt">Excerpt</label>
              <textarea
                id="article-excerpt"
                name="excerpt"
                rows="3"
                placeholder="Brief description of the article..."></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="article-category">Category</label>
                <select id="article-category" name="category_slug">
                  <option value="">Select Category</option>
                  <!-- Categories will be loaded dynamically -->
                </select>
              </div>

              <div class="form-group">
                <label for="article-read-time">Read Time (minutes)</label>
                <input
                  type="number"
                  id="article-read-time"
                  name="read_time_minutes"
                  min="1"
                  placeholder="5"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="article-image">Featured Image URL</label>
              <input
                type="url"
                id="article-image"
                name="featured_image_url"
                placeholder="https://example.com/image.jpg"
              />
            </div>

            <div class="form-group">
              <label for="article-content">Content *</label>
              <!-- Rich Text Editor Toolbar -->
              <div class="article-formatting-toolbar">
                <div class="format-buttons">
                  <button type="button" class="format-btn" data-format="bold" title="Bold">
                    <strong>B</strong>
                  </button>
                  <button type="button" class="format-btn" data-format="italic" title="Italic">
                    <em>I</em>
                  </button>
                  <button type="button" class="format-btn" data-format="code" title="Code">
                    <code>&lt;/&gt;</code>
                  </button>
                  <button type="button" class="format-btn" data-format="link" title="Link">
                    <span>üîó</span>
                  </button>
                  <div class="relative" style="position: relative;">
                    <button type="button" class="emoji-btn" id="article-emoji-btn" title="Emoji">
                      <span>üòä</span>
                    </button>
                    <div id="article-emoji-picker" class="article-emoji-picker" style="display: none;"></div>
                  </div>
                </div>
                <div class="character-count">
                  <span class="count" id="article-content-count">0</span>
                  <span> characters</span>
                </div>
              </div>
              <textarea
                id="article-content"
                name="content"
                rows="15"
                required
                placeholder="Write your article content here..."></textarea>
              <small class="form-help">You can use Markdown formatting (Bold: **text**, Italic: *text*, Code: `code`)</small>
            </div>

            <div class="checkbox-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="article-published"
                  name="is_published"
                />
                <span>Published</span>
                <small>Make this article visible to readers</small>
              </label>
            </div>

            <div class="form-actions">
              <button type="button" class="cancel-btn" id="article-cancel">
                Cancel
              </button>
              <button type="submit" class="save-btn" id="article-save">
                <span
                  class="btn-spinner"
                  id="save-spinner"
                  style="display: none;"
                >
                  <div class="simple-spinner small"></div>
                </span>
                <i class="fas fa-save"></i>
                Save Article
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</ProfileLayout>

<style>
  /* Import admin styles for articles */
  @import "../../styles/admin-global.css";

  .articles-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .articles-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #e2e8f0;
  }

  .dark .articles-header {
    border-bottom-color: #334155;
  }

  .header-content h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
  }

  .dark .header-content h1 {
    color: #f8fafc;
  }

  .header-content p {
    color: #64748b;
    margin: 0;
  }

  .dark .header-content p {
    color: #94a3b8;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
  }

  .create-article-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #243788;
    color: white;
    border: 2px solid #243788;
    border-radius: 0;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .create-article-btn:hover {
    background: #1e2f6b;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(36, 55, 136, 0.3);
  }

  .articles-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    border: 2px solid #e2e8f0;
    padding: 1.5rem;
    border-radius: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
  }

  .dark .stat-card {
    background: #1e293b;
    border-color: #334155;
  }

  .stat-card:hover {
    border-color: #243788;
    transform: translateY(-2px);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0;
    font-size: 1.5rem;
  }

  .stat-card.primary .stat-icon {
    background: rgba(36, 55, 136, 0.1);
    color: #243788;
  }

  .stat-card.success .stat-icon {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }

  .stat-card.warning .stat-icon {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
  }

  .stat-content {
    flex: 1;
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
  }

  .dark .stat-number {
    color: #f8fafc;
  }

  .stat-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .dark .stat-label {
    color: #94a3b8;
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: transparent;
    border: 2px dashed #e2e8f0;
    border-radius: 0;
  }

  .dark .empty-state {
    background: transparent;
    border-color: #334155;
  }

  .empty-state i {
    font-size: 4rem;
    color: #64748b;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .dark .empty-state h3 {
    color: #f8fafc;
  }

  .empty-state p {
    color: #64748b;
    margin-bottom: 2rem;
  }

  .dark .empty-state p {
    color: #94a3b8;
  }

  .create-first-article-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: #243788;
    color: white;
    border: 1px solid #243788;
    border-radius: 0;
    font-weight: 500;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .create-first-article-btn:hover {
    background: #1e2f6b;
    transform: translateY(-2px);
  }

  /* Loading and Error Styles */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .loading-spinner span {
    color: #64748b;
    font-weight: 600;
  }

  .dark .loading-spinner span {
    color: #94a3b8;
  }

  .error-banner {
    background: #fee2e2;
    border: 2px solid #ef4444;
    color: #991b1b;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-radius: 0;
  }

  .dark .error-banner {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #fca5a5;
  }

  .retry-btn {
    margin-left: auto;
    padding: 0.5rem 1rem;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-weight: 600;
  }

  /* Simple Spinner */
  .simple-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(36, 55, 136, 0.1);
    border-top-color: #243788;
    border-radius: 50%;
    animation: spinner-rotate 0.8s linear infinite;
  }

  .simple-spinner.small {
    width: 20px;
    height: 20px;
    border-width: 2px;
  }

  @keyframes spinner-rotate {
    to {
      transform: rotate(360deg);
    }
  }

  /* Rich Text Editor Toolbar Styles */
  .article-formatting-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    position: relative;
  }

  .dark .article-formatting-toolbar {
    background: #1e293b;
    border-color: #334155;
  }

  .article-formatting-toolbar .format-buttons {
    display: flex;
    gap: 0.25rem;
  }

  .article-formatting-toolbar .format-btn,
  .article-formatting-toolbar .emoji-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    border-radius: 4px;
  }

  .dark .article-formatting-toolbar .format-btn,
  .dark .article-formatting-toolbar .emoji-btn {
    border-color: #334155;
    background: #334155;
    color: #f8fafc;
  }

  .article-formatting-toolbar .format-btn:hover,
  .article-formatting-toolbar .emoji-btn:hover {
    background: #e5e7eb;
    border-color: #3b82f6;
    transform: translateY(-1px);
  }

  .dark .article-formatting-toolbar .format-btn:hover,
  .dark .article-formatting-toolbar .emoji-btn:hover {
    background: #475569;
    border-color: #60a5fa;
  }

  .article-formatting-toolbar .format-btn.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
  }

  .article-formatting-toolbar .character-count {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
  }

  .dark .article-formatting-toolbar .character-count {
    color: #94a3b8;
  }

  .article-formatting-toolbar .character-count .count {
    font-weight: 600;
  }

  .article-emoji-picker {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 4px;
    z-index: 1000;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    max-width: 200px;
  }

  .dark .article-emoji-picker {
    background: #1e293b;
    border-color: #334155;
  }

  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.25rem;
  }

  .emoji-option {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1.25rem;
    transition: all 0.2s ease;
    padding: 0;
  }

  .emoji-option:hover {
    background: #f3f4f6;
    border-color: #e5e7eb;
  }

  .dark .emoji-option:hover {
    background: #334155;
    border-color: #475569;
  }

  .article-formatting-toolbar + textarea {
    border-radius: 0 0 6px 6px;
    border-top: 1px solid #e5e7eb;
  }

  .dark .article-formatting-toolbar + textarea {
    border-top-color: #334155;
  }

  /* Notification Styles */
  .article-notification {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 0;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    min-width: 300px;
    max-width: 500px;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
  }

  .dark .article-notification {
    background: #1e293b;
    border-color: #334155;
  }

  .article-notification.show {
    opacity: 1;
    transform: translateX(0);
  }

  .article-notification.success {
    border-left: 4px solid #10b981;
  }

  .article-notification.error {
    border-left: 4px solid #ef4444;
  }

  .notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
  }

  .notification-content i {
    font-size: 1.25rem;
  }

  .article-notification.success .notification-content i {
    color: #10b981;
  }

  .article-notification.error .notification-content i {
    color: #ef4444;
  }

  .notification-content span {
    color: #1e293b;
    font-weight: 500;
    font-size: 0.875rem;
  }

  .dark .notification-content span {
    color: #f8fafc;
  }

  .notification-close {
    background: none;
    border: none;
    color: #64748b;
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s ease;
  }

  .notification-close:hover {
    color: #1e293b;
  }

  .dark .notification-close {
    color: #94a3b8;
  }

  .dark .notification-close:hover {
    color: #f8fafc;
  }

  /* Save button loading state */
  #article-save:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .articles-header {
      flex-direction: column;
      gap: 1rem;
    }

    .articles-stats-grid {
      grid-template-columns: 1fr;
    }

    .articles-grid {
      grid-template-columns: 1fr;
    }

    .article-notification {
      top: 1rem;
      right: 1rem;
      left: 1rem;
      min-width: auto;
      max-width: none;
    }
  }
</style>

<script>
  import { supabase } from "../../lib/supabase.js";

  interface Article {
    id: string;
    title: string;
    slug: string;
    subtitle?: string;
    excerpt?: string;
    content: string;
    is_published: boolean;
    is_featured: boolean;
    is_premium: boolean;
    featured_image_url?: string;
    read_time_minutes?: number;
    view_count: number;
    like_count: number;
    comment_count: number;
    published_at?: string;
    created_at: string;
    updated_at: string;
    category_slug?: string;
    categories?: {
      name: string;
      slug: string;
      color: string;
    };
  }

  interface Category {
    id: string;
    name: string;
    slug: string;
    color: string;
  }

  // Global state
  let articles: Article[] = [];
  let categories: Category[] = [];
  let currentEditingArticleId: string | null = null;
  let currentPage = 1;
  let totalPages = 1;
  let isLoading = false;

  // VERSION CHECK - If you see this, the new code is loaded!
  console.log("üîÑ CODE VERSION: 2026-01-08-v5 - NEW CODE LOADED!");
  console.log("üîÑ TIMESTAMP:", new Date().toISOString());

  // Initialize articles management
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError || !session?.user) {
        throw new Error("Authentication required. Please sign in to access this page.");
      }

      await initializeArticlesManagement();
    } catch (error: any) {
      console.error("Articles management initialization error:", error);
      showError(error.message || "Failed to initialize articles management.");
    }
  });

  async function initializeArticlesManagement() {
    showLoading(true);

    try {
      // No need to initialize admin API manager - we query Supabase directly
      // Only initialize it for create/update operations (which we handle separately)
      
      await Promise.all([
        loadArticles(),
        loadCategories(),
        updateStats(),
      ]);

      setupEventListeners();
      showLoading(false);
    } catch (error: any) {
      console.error("Initialization error:", error);
      showError(error.message || "Failed to load articles data");
      showLoading(false);
    }
  }

  async function loadArticles(page = 1) {
    try {
      if (isLoading) return;
      isLoading = true;

      // Get current user to filter articles
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("User not authenticated");

      // Generate author slug from user ID
      const authorSlug = 'user-' + user.id.split('-')[0];

      const limit = 20;
      const from = (page - 1) * limit;
      const to = from + limit - 1;

      // Query articles directly from Supabase for current user
      const { data, error, count } = await supabase
        .from("articles")
        .select(
          `
          *,
          categories:category_slug(name, slug, color)
        `,
          { count: "exact" }
        )
        .eq("author_id", authorSlug)
        .order("created_at", { ascending: false })
        .range(from, to);

      if (error) {
        throw new Error(error.message || "Failed to load articles");
      }

      articles = (data || []) as Article[];
      currentPage = page;
      totalPages = count ? Math.ceil(count / limit) : 1;

      renderArticles();
      renderPagination({
        currentPage: page,
        totalPages,
        total: count || 0,
        limit,
      });
    } catch (error: any) {
      console.error("Load articles error:", error);
      showError("Failed to load articles");
    } finally {
      isLoading = false;
    }
  }

  async function loadCategories() {
    try {
      // Load categories directly from Supabase
      const { data, error } = await supabase
        .from("categories")
        .select("id, name, slug, color")
        .order("name", { ascending: true });

      if (error) {
        console.error("Load categories error:", error);
        return;
      }

      categories = (data || []) as Category[];
      populateCategoryOptions();
    } catch (error: any) {
      console.error("Load categories error:", error);
    }
  }

  function populateCategoryOptions() {
    const categorySelect = document.getElementById("article-category") as HTMLSelectElement;
    if (!categorySelect) return;

    // Clear existing options except the first one
    while (categorySelect.options.length > 1) {
      categorySelect.remove(1);
    }

    categories.forEach((category) => {
      const option = document.createElement("option");
      option.value = category.slug;
      option.textContent = category.name;
      categorySelect.appendChild(option);
    });
  }

  async function updateStats() {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      // Generate author slug from user ID
      const authorSlug = 'user-' + user.id.split('-')[0];

      // Get stats directly from Supabase
      const [totalResult, publishedResult, draftResult] = await Promise.all([
        supabase
          .from("articles")
          .select("*", { count: "exact", head: true })
          .eq("author_id", authorSlug),
        supabase
          .from("articles")
          .select("*", { count: "exact", head: true })
          .eq("author_id", authorSlug)
          .eq("is_published", true),
        supabase
          .from("articles")
          .select("*", { count: "exact", head: true })
          .eq("author_id", authorSlug)
          .eq("is_published", false),
      ]);

      const totalCount = totalResult.count || 0;
      const publishedCount = publishedResult.count || 0;
      const draftCount = draftResult.count || 0;

      const totalEl = document.getElementById("total-articles");
      const publishedEl = document.getElementById("published-articles");
      const draftEl = document.getElementById("draft-articles");

      if (totalEl) totalEl.textContent = totalCount.toString();
      if (publishedEl) publishedEl.textContent = publishedCount.toString();
      if (draftEl) draftEl.textContent = draftCount.toString();
    } catch (error: any) {
      console.error("Update stats error:", error);
    }
  }

  function renderArticles() {
    const grid = document.getElementById("articles-grid");
    const emptyState = document.getElementById("empty-state");

    if (!grid) return;

    if (articles.length === 0) {
      grid.style.display = "none";
      if (emptyState) emptyState.style.display = "block";
      return;
    }

    grid.style.display = "grid";
    if (emptyState) emptyState.style.display = "none";

    grid.innerHTML = articles
      .map(
        (article) => `
      <div class="article-card">
        <div class="article-image">
          ${
            article.featured_image_url
              ? `<img src="${article.featured_image_url}" alt="${article.title}" />`
              : `<div class="article-image-placeholder"><i class="fas fa-image"></i></div>`
          }
        </div>
        <div class="article-content">
          <div class="article-meta">
            <span class="article-status ${article.is_published ? "published" : "draft"}">
              ${article.is_published ? "Published" : "Draft"}
            </span>
            <span class="article-date">
              ${new Date(article.created_at).toLocaleDateString()}
            </span>
          </div>
          <h3 class="article-title">${article.title}</h3>
          ${article.excerpt ? `<p class="article-excerpt">${article.excerpt}</p>` : ""}
          <div class="article-stats">
            <span><i class="fas fa-eye"></i> ${article.view_count || 0}</span>
            <span><i class="fas fa-heart"></i> ${article.like_count || 0}</span>
            <span><i class="fas fa-comment"></i> ${article.comment_count || 0}</span>
          </div>
          <div class="article-actions">
            <button class="action-btn edit" onclick="editArticle('${article.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <a href="/blog/${article.slug}" class="action-btn view" target="_blank">
              <i class="fas fa-external-link-alt"></i> View
            </a>
          </div>
        </div>
      </div>
    `
      )
      .join("");
  }

  function renderPagination(pagination?: any) {
    const container = document.getElementById("pagination-container");
    if (!container) return;

    if (!pagination || pagination.totalPages <= 1) {
      container.style.display = "none";
      return;
    }

    container.style.display = "block";
    container.innerHTML = `
      <div class="pagination-buttons">
        <button 
          class="pagination-btn" 
          ${currentPage === 1 ? "disabled" : ""}
          onclick="goToPage(${currentPage - 1})"
        >
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span class="pagination-info">
          Page ${currentPage} of ${pagination.totalPages}
        </span>
        <button 
          class="pagination-btn" 
          ${currentPage === pagination.totalPages ? "disabled" : ""}
          onclick="goToPage(${currentPage + 1})"
        >
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    `;
  }

  function setupEventListeners() {
    const createArticleBtn = document.getElementById("create-article-btn");
    createArticleBtn?.addEventListener("click", () => openArticleModal());

    const createFirstBtn = document.getElementById("create-first-article");
    createFirstBtn?.addEventListener("click", () => openArticleModal());

    const modalClose = document.getElementById("article-modal-close");
    const cancelBtn = document.getElementById("article-cancel");
    modalClose?.addEventListener("click", closeArticleModal);
    cancelBtn?.addEventListener("click", closeArticleModal);

    const modal = document.getElementById("article-modal");
    modal?.addEventListener("click", (e) => {
      if (e.target === modal) closeArticleModal();
    });

    const articleForm = document.getElementById("article-form") as HTMLFormElement;
    console.log("üîß Setting up article form listeners...", articleForm ? "Form found" : "Form NOT found");
    
    if (articleForm) {
      // Attach submit handler directly
      articleForm.onsubmit = async (e: Event) => {
        console.log("üìù Form submit event fired (onsubmit)");
        await handleArticleFormSubmit(e);
      };
      
      console.log("‚úÖ Form submit handler attached");
      
      // Also add direct click handler to save button as backup
      const saveBtn = document.getElementById("article-save") as HTMLButtonElement;
      console.log("üîß Save button:", saveBtn ? "Found" : "NOT found");
      
      if (saveBtn) {
        saveBtn.onclick = async (e: MouseEvent) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("üîµ Save button clicked directly");
          
          // Trigger form validation
          if (articleForm.checkValidity()) {
            console.log("‚úÖ Form is valid, dispatching submit event");
            const submitEvent = new Event("submit", { bubbles: true, cancelable: true });
            articleForm.dispatchEvent(submitEvent);
          } else {
            console.log("‚ùå Form validation failed on button click");
            articleForm.reportValidity();
            showNotification("Please fill in all required fields", "error");
          }
        };
        
        console.log("‚úÖ Save button click handler attached");
      }
    }

    const titleInput = document.getElementById("article-title") as HTMLInputElement;
    const slugInput = document.getElementById("article-slug") as HTMLInputElement;

    titleInput?.addEventListener("input", (e) => {
      const title = (e.target as HTMLInputElement).value;
      const slug = title
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .trim();
      if (slugInput && !currentEditingArticleId) {
        slugInput.value = slug;
      }
    });

    const contentTextarea = document.getElementById("article-content") as HTMLTextAreaElement;
    contentTextarea?.addEventListener("input", () => {
      const count = document.getElementById("article-content-count");
      if (count) {
        count.textContent = contentTextarea.value.length.toString();
      }
    });

    // Format buttons
    document.querySelectorAll(".format-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const format = (btn as HTMLElement).dataset.format;
        if (format && contentTextarea) {
          insertFormatting(contentTextarea, format);
        }
      });
    });

    // Emoji picker setup
    const emojiBtn = document.getElementById("article-emoji-btn");
    const emojiPicker = document.getElementById("article-emoji-picker");
    if (emojiBtn && emojiPicker && contentTextarea) {
      setupEmojiPicker(emojiBtn, emojiPicker, contentTextarea);
    }

    const retryBtn = document.getElementById("retry-btn");
    retryBtn?.addEventListener("click", () => {
      hideError();
      initializeArticlesManagement();
    });
  }

  function insertFormatting(textarea: HTMLTextAreaElement, format: string) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    let before = "";
    let after = "";

    switch (format) {
      case "bold":
        before = "**";
        after = "**";
        break;
      case "italic":
        before = "*";
        after = "*";
        break;
      case "code":
        before = "`";
        after = "`";
        break;
      case "link":
        before = "[";
        after = selectedText ? "](url)" : "text](url)";
        break;
    }

    const newValue =
      textarea.value.substring(0, start) +
      before +
      selectedText +
      after +
      textarea.value.substring(end);

    textarea.value = newValue;
    textarea.focus();
    const newCursorPos = start + before.length + selectedText.length + after.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);

    // Update character count
    const charCount = document.getElementById("article-content-count");
    if (charCount) {
      charCount.textContent = textarea.value.length.toString();
    }
  }

  function setupEmojiPicker(btn: HTMLElement, picker: HTMLElement, textarea: HTMLTextAreaElement) {
    const commonEmojis = [
      "üòÄ", "üòä", "üòÇ", "‚ù§Ô∏è", "üëç", "üëé", "üéâ", "üî•", "üíØ", "‚ú®", "üöÄ", "üí™",
      "üôè", "üëè", "üéä", "üí°", "‚≠ê", "üåü", "üí¨", "üìù", "üìå", "üîó", "üíª", "üéØ",
      "‚úÖ", "‚ùå", "‚ö†Ô∏è", "‚ÑπÔ∏è", "üì¢", "üé®", "üìö", "üîç"
    ];

    // Create emoji grid (only if not already created)
    if (!picker.querySelector('.emoji-grid')) {
      picker.innerHTML = `
        <div class="emoji-grid">
          ${commonEmojis.map(emoji => `
            <button type="button" class="emoji-option" data-emoji="${emoji}">
              ${emoji}
            </button>
          `).join("")}
        </div>
      `;
    }

    // Toggle picker
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const isVisible = picker.style.display !== "none";
      picker.style.display = isVisible ? "none" : "block";
    });

    // Close on emoji select
    picker.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const emojiBtn = target.closest(".emoji-option");
      if (emojiBtn) {
        const emoji = (emojiBtn as HTMLElement).dataset.emoji;
        if (emoji) {
          insertEmoji(textarea, emoji);
          picker.style.display = "none";
        }
      }
    });

    // Close on outside click
    document.addEventListener("click", (e) => {
      if (!picker.contains(e.target as Node) && !btn.contains(e.target as Node)) {
        picker.style.display = "none";
      }
    });
  }

  function insertEmoji(textarea: HTMLTextAreaElement, emoji: string) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const newValue =
      textarea.value.substring(0, start) +
      emoji +
      textarea.value.substring(end);

    textarea.value = newValue;
    textarea.focus();
    const newCursorPos = start + emoji.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);

    // Update character count
    const charCount = document.getElementById("article-content-count");
    if (charCount) {
      charCount.textContent = textarea.value.length.toString();
    }
  }

  function openArticleModal(article?: Article) {
    const modal = document.getElementById("article-modal");
    const modalTitle = document.getElementById("article-modal-title");
    const form = document.getElementById("article-form") as HTMLFormElement;

    if (!modal || !modalTitle || !form) return;

    if (article) {
      currentEditingArticleId = article.id;
      modalTitle.textContent = "Edit Article";

      (document.getElementById("article-title") as HTMLInputElement).value = article.title;
      (document.getElementById("article-slug") as HTMLInputElement).value = article.slug;
      (document.getElementById("article-subtitle") as HTMLInputElement).value = article.subtitle || "";
      (document.getElementById("article-excerpt") as HTMLTextAreaElement).value = article.excerpt || "";
      (document.getElementById("article-category") as HTMLSelectElement).value = article.category_slug || "";
      (document.getElementById("article-read-time") as HTMLInputElement).value = article.read_time_minutes?.toString() || "";
      (document.getElementById("article-image") as HTMLInputElement).value = article.featured_image_url || "";
      (document.getElementById("article-content") as HTMLTextAreaElement).value = article.content;
      (document.getElementById("article-published") as HTMLInputElement).checked = article.is_published;
    } else {
      currentEditingArticleId = null;
      modalTitle.textContent = "Create Article";
      form.reset();
    }

    // Ensure save button is enabled and reset
    const saveBtn = document.getElementById("article-save") as HTMLButtonElement;
    const saveSpinner = document.getElementById("save-spinner");
    if (saveBtn) {
      saveBtn.disabled = false;
      // Ensure button can be clicked
      saveBtn.onclick = null;
    }
    if (saveSpinner) {
      saveSpinner.style.display = "none";
    }

    modal.style.display = "flex";
    
    // Initialize rich text editor after modal opens
    setTimeout(() => {
      const contentTextarea = document.getElementById("article-content") as HTMLTextAreaElement;
      if (contentTextarea) {
        // Update character count
        const charCount = document.getElementById("article-content-count");
        if (charCount) {
          charCount.textContent = contentTextarea.value.length.toString();
        }

        // Setup emoji picker
        const emojiBtn = document.getElementById("article-emoji-btn");
        const emojiPicker = document.getElementById("article-emoji-picker");
        if (emojiBtn && emojiPicker) {
          setupEmojiPicker(emojiBtn, emojiPicker, contentTextarea);
        }
      }
    }, 100);
  }

  function closeArticleModal() {
    const modal = document.getElementById("article-modal");
    if (modal) {
      modal.style.display = "none";
    }
    currentEditingArticleId = null;
  }

  async function handleArticleFormSubmit(e: Event) {
    e.preventDefault();
    e.stopPropagation();

    console.log("üìù Form submission started");

    const form = e.target as HTMLFormElement;
    console.log("üîç Form element:", form);
    
    if (!form) {
      console.error("‚ùå Form not found");
      showNotification("Form error: Form not found", "error");
      return;
    }

    console.log("‚úÖ Form found, checking validity...");

    // Check form validity
    if (!form.checkValidity()) {
      console.error("‚ùå Form validation failed");
      console.log("Invalid fields:", Array.from(form.elements).filter((el: any) => !el.validity?.valid));
      form.reportValidity();
      showNotification("Please fill in all required fields", "error");
      return;
    }

    console.log("‚úÖ Form is valid, getting form data...");
    const formData = new FormData(form);
    console.log("üìã Form data entries:", Array.from(formData.entries()).map(([k, v]) => [k, typeof v === 'string' ? v.substring(0, 50) : v]));

    console.log("üîê Getting current user...");
    
    // SIMPLE VERSION - Just get the user directly
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    
    console.log("üë§ User result:", user ? `User ID: ${user.id}` : "No user", userError);
    
    if (userError || !user) {
      console.error("‚ùå User authentication error:", userError);
      showNotification("You must be signed in to create articles", "error");
      return;
    }

    console.log("‚úÖ User authenticated successfully");

    // Show loading state on save button
    const saveBtn = document.getElementById("article-save") as HTMLButtonElement;
    const saveSpinner = document.getElementById("save-spinner");
    const originalSaveBtnContent = saveBtn?.innerHTML || "";

    if (saveBtn) {
      saveBtn.disabled = true;
      if (saveSpinner) saveSpinner.style.display = "inline-block";
    }

    const title = (formData.get("title") as string)?.trim();
    const slug = (formData.get("slug") as string)?.trim();
    const content = (formData.get("content") as string)?.trim();

    // Validate required fields
    if (!title) {
      showNotification("Article title is required", "error");
      if (saveBtn) saveBtn.disabled = false;
      if (saveSpinner) saveSpinner.style.display = "none";
      return;
    }
    if (!slug) {
      showNotification("Article slug is required", "error");
      if (saveBtn) saveBtn.disabled = false;
      if (saveSpinner) saveSpinner.style.display = "none";
      return;
    }
    if (!content) {
      showNotification("Article content is required", "error");
      if (saveBtn) saveBtn.disabled = false;
      if (saveSpinner) saveSpinner.style.display = "none";
      return;
    }

    // Generate author slug from user ID (matching the format we used in the INSERT)
    const authorSlug = 'user-' + user.id.split('-')[0]; // e.g., 'user-da8ee08f'
    console.log("üìù Using author slug:", authorSlug);

    const articleData: any = {
      title,
      slug,
      subtitle: (formData.get("subtitle") as string)?.trim() || undefined,
      excerpt: (formData.get("excerpt") as string)?.trim() || undefined,
      content,
      category_slug: (formData.get("category_slug") as string) || undefined,
      read_time_minutes: formData.get("read_time_minutes")
        ? parseInt(formData.get("read_time_minutes") as string)
        : undefined,
      featured_image_url: (formData.get("featured_image_url") as string)?.trim() || undefined,
      is_published: formData.has("is_published"),
      author_id: authorSlug, // Use author slug, not user ID
    };

    console.log("üìÑ Article data prepared:", { ...articleData, content: content.substring(0, 50) + "..." });

    // Remove undefined values
    Object.keys(articleData).forEach(key => {
      if (articleData[key] === undefined) {
        delete articleData[key];
      }
    });

    try {
      let savedArticle;
      const isEdit = currentEditingArticleId !== null;

      if (isEdit) {
        // Update article directly via Supabase
        const { data, error } = await supabase
          .from("articles")
          .update({
            ...articleData,
            updated_at: new Date().toISOString(),
          })
          .eq("id", currentEditingArticleId)
          .eq("author_id", authorSlug) // Ensure user owns the article (using slug)
          .select()
          .single();

        if (error) {
          throw new Error(error.message || "Failed to update article");
        }

        savedArticle = data;
        showNotification("Article updated successfully! üéâ", "success");
      } else {
        // Create article directly via Supabase
        const { data, error } = await supabase
          .from("articles")
          .insert({
            ...articleData,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          })
          .select()
          .single();

        if (error) {
          throw new Error(error.message || "Failed to create article");
        }

        savedArticle = data;
        showNotification("Article created successfully! üéâ", "success");
        
        // If published, show option to view article
        if (articleData.is_published && savedArticle?.slug) {
          setTimeout(() => {
            const viewArticle = confirm(
              "Your article has been published! Would you like to view it now?"
            );
            if (viewArticle) {
              window.open(`/blog/${savedArticle.slug}`, "_blank");
            }
          }, 500);
        }
      }

      // Close modal and refresh data
      closeArticleModal();
      
      // Reload articles list to show the new/updated article
      await loadArticles(1); // Go to first page to see the new article
      await updateStats();

      console.log("‚úÖ Article saved successfully:", savedArticle);
    } catch (error: any) {
      console.error("‚ùå Form submission error:", error);
      showNotification(
        error.message || "Failed to save article. Please try again.",
        "error"
      );
    } finally {
      // Restore save button state
      if (saveBtn) {
        saveBtn.disabled = false;
        if (saveSpinner) saveSpinner.style.display = "none";
      }
    }
  }

  async function editArticle(articleId: string) {
    try {
      // Get current user to verify ownership
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("User not authenticated");

      // Generate author slug from user ID
      const authorSlug = 'user-' + user.id.split('-')[0];

      // Fetch article and verify it belongs to the user
      const { data, error } = await supabase
        .from("articles")
        .select("*")
        .eq("id", articleId)
        .eq("author_id", authorSlug)
        .single();

      if (error || !data) {
        throw new Error("Article not found or you don't have permission to edit it");
      }

      openArticleModal(data as Article);
    } catch (error: any) {
      console.error("Edit article error:", error);
      showNotification(error.message || "Failed to load article", "error");
    }
  }

  function showLoading(show: boolean) {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.style.display = show ? "flex" : "none";
    }
  }

  function showError(message: string) {
    const banner = document.getElementById("error-banner");
    const messageEl = document.getElementById("error-message");
    if (banner) banner.style.display = "flex";
    if (messageEl) messageEl.textContent = message;
  }

  function hideError() {
    const banner = document.getElementById("error-banner");
    if (banner) banner.style.display = "none";
  }

  function showNotification(message: string, type: "success" | "error") {
    // Remove any existing notifications
    const existingNotification = document.getElementById("article-notification");
    if (existingNotification) {
      existingNotification.remove();
    }

    // Create notification element
    const notification = document.createElement("div");
    notification.id = "article-notification";
    notification.className = `article-notification ${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <i class="fas ${type === "success" ? "fa-check-circle" : "fa-exclamation-circle"}"></i>
        <span>${message}</span>
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Show notification with animation
    setTimeout(() => {
      notification.classList.add("show");
    }, 10);

    // Auto-remove after 5 seconds for success, 8 seconds for error
    setTimeout(() => {
      notification.classList.remove("show");
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, type === "success" ? 5000 : 8000);
  }

  // Make functions globally available
  (window as any).editArticle = editArticle;
  (window as any).goToPage = async (page: number) => {
    await loadArticles(page);
  };
</script>
