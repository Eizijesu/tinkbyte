---
// src/layouts/BlogPost.astro - Enhanced TinaCMS compatibility
import Layout from "./Layout.astro";
import { SITE } from "../config/site.ts";
import Button from "../components/ui/Button.astro";
import ShareButtons from "../components/ui/ShareButtons.astro";
import ProgressBar from "../components/ui/ProgressBar.astro";
import CommentSection from "../components/blog/CommentSection.astro";
import RelatedPosts from "../components/blog/RelatedPosts.astro";
import TableOfContents from "../components/blog/TableOfContents.astro";
import { getCollection } from "astro:content";

export interface Props {
  title: string;
  description?: string;
  excerpt?: string;
  date: string;
  readTime?: string;
  tags: string[];
  category: string;
  author: string | {
    name: string;
    bio?: string;
    avatar?: string;
    role?: string;
    social?: any;
  };
  authorBio?: string;
  authorAvatar?: string;
  authorRole?: string;
  authorSocial?: any;
  audioUrl?: string;
  audioDuration?: string;
  image?: string;
  featured?: boolean;
  trending?: boolean;
  slug: string;
}

const {
  title,
  description,
  excerpt,
  date,
  readTime,
  tags,
  category,
  author,
  authorBio,
  authorAvatar,
  authorRole,
  authorSocial,
  audioUrl,
  audioDuration,
  image,
  featured = false,
  trending = false,
  slug,
} = Astro.props;

// Handle author data - TinaCMS compatibility
const authorData = typeof author === 'string' ? {
  name: author,
  bio: authorBio,
  avatar: authorAvatar,
  role: authorRole,
  social: authorSocial
} : author;

// Use description or excerpt
const postDescription = description || excerpt || "";

// Get all posts for navigation
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

// Find current post index
const currentIndex = sortedPosts.findIndex((post) => post.slug === slug);
const previousPost =
  currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

// Format date
const publishedTime = new Date(date).toISOString();
const formattedDate = new Date(date).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Enhanced category color mapping
const getCategoryColor = (cat: string | undefined) => {
  if (!cat) {
    return {
      bg: "bg-zinc-100 dark:bg-zinc-800",
      text: "text-zinc-800 dark:text-zinc-300",
      badge: "bg-zinc-500",
    };
  }
  
  const colors = {
    "AI Evolution": {
      bg: "bg-purple-100 dark:bg-purple-900/30",
      text: "text-purple-800 dark:text-purple-300",
      badge: "bg-purple-500",
    },
    "Product Strategy": {
      bg: "bg-green-100 dark:bg-green-900/30",
      text: "text-green-800 dark:text-green-300",
      badge: "bg-green-500",
    },
    "Tech Culture": {
      bg: "bg-blue-100 dark:bg-blue-900/30",
      text: "text-blue-800 dark:text-blue-300",
      badge: "bg-blue-500",
    },
    "Startup Lessons": {
      bg: "bg-orange-100 dark:bg-orange-900/30",
      text: "text-orange-800 dark:text-orange-300",
      badge: "bg-orange-500",
    },
    "Developer Tools": {
      bg: "bg-cyan-100 dark:bg-cyan-900/30",
      text: "text-cyan-800 dark:text-cyan-300",
      badge: "bg-cyan-500",
    },
    "Industry Analysis": {
      bg: "bg-red-100 dark:bg-red-900/30",
      text: "text-red-800 dark:text-red-300",
      badge: "bg-red-500",
    },
    "Emerging Tech": {
      bg: "bg-pink-100 dark:bg-pink-900/30",
      text: "text-pink-800 dark:text-pink-300",
      badge: "bg-pink-500",
    },
    "Future Tech": {
      bg: "bg-violet-100 dark:bg-violet-900/30",
      text: "text-violet-800 dark:text-violet-300",
      badge: "bg-violet-500",
    },
  };
  
  return colors[cat] || {
    bg: "bg-zinc-100 dark:bg-zinc-800",
    text: "text-zinc-800 dark:text-zinc-300",
    badge: "bg-zinc-500",
  };
};

const categoryColors = getCategoryColor(category);
const badgeColorClass = categoryColors?.badge || "bg-zinc-500";

// Create category slug for navigation
const categorySlug = category ? category.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '') : 'uncategorized';
---

<Layout
  title={`${title} | ${SITE.name}`}
  description={postDescription}
  image={image}
  type="article"
  publishedTime={publishedTime}
  author={authorData.name}
  tags={tags}
>
  <!-- Reading Progress Bar -->
  <ProgressBar />

  <!-- Article Container -->
  <article class="min-h-screen">
    <!-- Article Header -->
    <header class="max-w-4xl mx-auto px-4 sm:px-6 pt-12 pb-8">
      <!-- Breadcrumb Navigation -->
      <nav class="mb-8" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm text-zinc-500 dark:text-zinc-400">
          <li>
            <a
              href="/"
              class="hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors"
            >
              Home
            </a>
          </li>
          <li class="flex items-center gap-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <a
              href="/blog"
              class="hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors"
            >
              Articles
            </a>
          </li>
          <li class="flex items-center gap-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <a
              href={`/blog/categories/${categorySlug}`}
              class="hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors"
            >
              {category || 'Uncategorized'}
            </a>
          </li>
        </ol>
      </nav>

      <!-- Category Badge -->
      <div class="mb-8">
        <div class="inline-flex items-center px-3 py-1 rounded text-xs font-medium bg-zinc-100 dark:bg-zinc-800 text-zinc-800 dark:text-zinc-200 border border-zinc-200 dark:border-zinc-700 uppercase tracking-wide">
          <span class={`w-2 h-2 ${badgeColorClass} rounded-full mr-2 animate-pulse`}></span>
          {category ? category.toUpperCase() : 'UNCATEGORIZED'}
          {featured && (
            <>
              <span class="mx-2 text-zinc-400">â€¢</span>
              <span class="text-yellow-600 dark:text-yellow-400 flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                FEATURED
              </span>
            </>
          )}
          {trending && (
            <>
              <span class="mx-2 text-zinc-400">â€¢</span>
              <span class="text-orange-600 dark:text-orange-400 flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
                </svg>
                TRENDING
              </span>
            </>
          )}
        </div>
      </div>

      <!-- Article Title -->
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-zinc-900 dark:text-zinc-100 mb-6 leading-tight font-space-grotesk">
        {title}
      </h1>

      <!-- Article Subtitle/Description -->
      {postDescription && (
        <p class="text-xl lg:text-2xl text-zinc-600 dark:text-zinc-400 leading-relaxed mb-8 font-normal">
          {postDescription}
        </p>
      )}

      <!-- Author & Meta Information -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pb-6 border-b border-zinc-200 dark:border-zinc-800">
        <div class="flex items-center gap-4">
          <!-- Author Info -->
          <div class="flex items-center gap-3">
            {authorData.avatar && (
              <img
                src={authorData.avatar}
                alt={`${authorData.name} - Author`}
                class="w-10 h-10 rounded-full object-cover"
                loading="lazy"
              />
            )}
            <div>
              <div class="font-medium text-zinc-900 dark:text-zinc-100">
                By <span class="text-brand-primary hover:text-brand-dark transition-colors">
                  {authorData.name}
                </span>
              </div>
              {authorData.role && (
                <div class="text-sm text-zinc-500 dark:text-zinc-400">
                  {authorData.role}
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Meta Information -->
        <div class="flex items-center gap-4 text-sm text-zinc-500 dark:text-zinc-400">
          <time datetime={publishedTime} class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            {formattedDate}
          </time>
          {readTime && (
            <>
              <span class="w-1 h-1 bg-zinc-400 rounded-full"></span>
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {readTime}
              </span>
            </>
          )}
          {audioUrl && (
            <>
              <span class="w-1 h-1 bg-zinc-400 rounded-full"></span>
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M9 12a3 3 0 106 0v5a3 3 0 11-6 0V7a3 3 0 013-3z"></path>
                </svg>
                Audio available
              </span>
            </>
          )}
        </div>
      </div>
    </header>

    <!-- Featured Image with TOC -->
    {image && (
      <div class="max-w-4xl mx-auto px-4 sm:px-6 mb-12">
        <div class="relative">
          <a 
            href={`/blog/${slug}`} 
            class="block group cursor-pointer"
            aria-label={`View full article: ${title}`}
          >
            <div class="aspect-[16/9] overflow-hidden rounded-xl shadow-2xl group-hover:shadow-3xl transition-all duration-300">
              <img
                src={image}
                alt={`Featured image for: ${title}`}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                loading="eager"
              />
              
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300 flex items-center justify-center">
                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-sm px-6 py-3 rounded-full">
                  <span class="text-sm font-medium text-zinc-900 dark:text-zinc-100 uppercase tracking-wide">
                    ðŸ“– Read Full Article
                  </span>
                </div>
              </div>
            </div>
          </a>

          <!-- Table of Contents -->
          <div class="absolute top-4 right-4 w-80 max-w-[calc(100vw-2rem)] z-10">
            <TableOfContents />
          </div>
        </div>
      </div>
    )}

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <!-- Article Content -->
      <div class="prose prose-zinc dark:prose-invert prose-lg max-w-none mb-12">
        <slot />
      </div>

      <!-- Tags -->
      {tags && tags.length > 0 && (
        <div class="mb-8">
          <h3 class="text-sm font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-3">
            TAGS
          </h3>
          <div class="flex flex-wrap gap-2">
            {tags.map((tag) => (
              <a
                href={`/blog/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                class="px-3 py-1 bg-zinc-100 dark:bg-zinc-800 text-zinc-700 dark:text-zinc-300 text-sm rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors uppercase tracking-wide"
              >
                #{tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Share Buttons -->
      <ShareButtons title={title} url={`/blog/${slug}`} />

      <!-- Author Bio -->
      {authorData.bio && (
        <div class="mt-12 p-6 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl border border-zinc-200 dark:border-zinc-700">
          <div class="flex items-start gap-4">
            {authorData.avatar && (
              <img
                src={authorData.avatar}
                alt={authorData.name}
                class="w-16 h-16 rounded-full object-cover flex-shrink-0"
                loading="lazy"
              />
            )}
            <div class="flex-1">
              <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100 mb-1">
                {authorData.name}
              </h3>
              {authorData.role && (
                <p class="text-sm text-zinc-600 dark:text-zinc-400 mb-3">
                  {authorData.role}
                </p>
              )}
              <p class="text-zinc-700 dark:text-zinc-300 mb-4">
                {authorData.bio}
              </p>
              {authorData.social && (
                <div class="flex gap-3">
                  {authorData.social.twitter && (
                    <a
                      href={`https://twitter.com/${authorData.social.twitter}`}
                      class="text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors"
                      aria-label={`Follow ${authorData.name} on Twitter`}
                    >
                      <i class="fab fa-twitter"></i>
                    </a>
                  )}
                  {authorData.social.linkedin && (
                    <a
                      href={authorData.social.linkedin}
                      class="text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors"
                      aria-label={`Connect with ${authorData.name} on LinkedIn`}
                    >
                      <i class="fab fa-linkedin"></i>
                    </a>
                  )}
                  {authorData.social.github && (
                    <a
                      href={`https://github.com/${authorData.social.github}`}
                      class="text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors"
                      aria-label={`Follow ${authorData.name} on GitHub`}
                    >
                      <i class="fab fa-github"></i>
                    </a>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      <!-- Navigation -->
      <div class="mt-12 grid md:grid-cols-2 gap-6">
        {previousPost && (
          <div class="group">
            <div class="text-sm font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-2">
              PREVIOUS ARTICLE
            </div>
            <a
              href={`/blog/${previousPost.slug}`}
              class="block p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-lg border border-zinc-200 dark:border-zinc-700 hover:border-zinc-300 dark:hover:border-zinc-600 transition-colors"
            >
              <h3 class="font-semibold text-zinc-900 dark:text-zinc-100 group-hover:text-zinc-700 dark:group-hover:text-zinc-300 transition-colors">
                {previousPost.data.title}
              </h3>
            </a>
          </div>
        )}
        
        {nextPost && (
          <div class="group">
            <div class="text-sm font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-2 text-right md:text-left">
              NEXT ARTICLE
            </div>
            <a
              href={`/blog/${nextPost.slug}`}
              class="block p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-lg border border-zinc-200 dark:border-zinc-700 hover:border-zinc-300 dark:hover:border-zinc-600 transition-colors"
            >
              <h3 class="font-semibold text-zinc-900 dark:text-zinc-100 group-hover:text-zinc-700 dark:group-hover:text-zinc-300 transition-colors">
                {nextPost.data.title}
              </h3>
            </a>
          </div>
        )}
      </div>

      <!-- Related Posts -->
      <RelatedPosts currentSlug={slug} category={category} tags={tags} />

      <!-- Comments -->
      <CommentSection />
    </div>
  </article>
</Layout>