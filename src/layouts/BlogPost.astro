---
// src/layouts/BlogPost.astro
import Layout from "./Layout.astro";
import { Image } from "astro:assets";
import ShareButtons from "../components/ui/ShareButtons.astro";
import RelatedPosts from "../components/blog/RelatedPosts.astro";
import AudioPlayer from "../components/ui/AudioPlayer.astro";
import AuthorBio from "../components/blog/AuthorBio.astro";
import ReactionBar from "../components/blog/ReactionBar.astro";
import { SITE } from "../config/site";
import { getCollection } from "astro:content";
import MDXProvider from "../components/MDXProvider.astro";
import TinkByteCommentSection from "../components/comments/TinkByteCommentSection.astro";
import FeedbackWidget from "../components/ui/FeedbackWidget.astro";

// Import TinaCMS components properly
import ImageBlock from "../components/tina/ImageBlock.astro";
import VideoBlock from "../components/tina/VideoBlock.astro";
import CalloutBox from "../components/tina/CalloutBox.astro";
import ButtonBlock from "../components/tina/ButtonBlock.astro";
import CodeBlock from "../components/tina/CodeBlock.astro";
import Quote from "../components/tina/Quote.astro";
import TableBlock from "../components/tina/TableBlock.astro";
import ImageGallery from "../components/tina/ImageGallery.astro";
import TwoColumnLayout from "../components/tina/TwoColumnLayout.astro";
import Newsletter from "../components/tina/Newsletter.astro";

export interface Props {
  title: string;
  subtitle?: string;
  description?: string;
  excerpt?: string;
  date: string | Date;
  updatedDate?: string | Date;
  readTime?: string;
  tags: string[];
  category?: string;
  authorInfo?: {
    name: string;
    bio?: string;
    avatar?: string;
    role?: string;
    social?: {
      twitter?: string;
      linkedin?: string;
      github?: string;
      website?: string;
    };
  };
  author?: string;
  heroImage?: {
    imageType: "upload" | "url";
    uploadedImage?: string;
    externalUrl?: string;
    alt: string;
    caption?: string;
  };
  image?: string;
  imageAlt?: string;
  audioUrl?: string;
  audioDuration?: string;
  slug?: string;
  featured?: boolean;
  trending?: boolean;
  navigationContext?: any;
  analyticsData?: any;
  seoTitle?: string;
  seoDescription?: string;
  canonicalUrl?: string;
  headings?: any[];
  renderError?: any;
  showReadingProgress?: boolean;
}

const {
  title,
  subtitle,
  description,
  excerpt,
  date,
  readTime,
  tags = [],
  category,
  authorInfo,
  author,
  heroImage,
  image,
  imageAlt,
  audioUrl,
  audioDuration,
  slug,
  showReadingProgress = true,
} = Astro.props;

// Enhanced slug resolution with multiple fallbacks
const resolveArticleId = () => {
  if (slug && slug.trim()) {
    return slug.trim();
  }

  if (Astro.params.slug && Astro.params.slug.trim()) {
    return Astro.params.slug.trim();
  }

  const pathname = Astro.url.pathname;
  const pathSegments = pathname
    .split("/")
    .filter((segment) => segment.length > 0);
  if (pathSegments.length > 0) {
    const lastSegment = pathSegments[pathSegments.length - 1];
    if (lastSegment && lastSegment !== "blog" && lastSegment.length > 0) {
      return lastSegment;
    }
  }

  if (title && title.trim()) {
    return title
      .toLowerCase()
      .replace(/[^\w\s-]/g, "")
      .replace(/\s+/g, "-")
      .replace(/-+/g, "-")
      .trim();
  }

  return `article-${Date.now()}`;
};

const articleId = resolveArticleId();

// Robust author data handling
const getAuthorData = () => {
  if (authorInfo && authorInfo.name) {
    return {
      name: authorInfo.name,
      bio: authorInfo.bio || null,
      avatar: authorInfo.avatar || null,
      role: authorInfo.role || null,
      social: authorInfo.social || null,
    };
  }

  if (author) {
    return {
      name: author,
      bio: null,
      avatar: null,
      role: null,
      social: null,
    };
  }

  return {
    name: "TinkByte Team",
    bio: null,
    avatar: null,
    role: null,
    social: null,
  };
};

const authorData = getAuthorData();

const getImageSrc = () => {
  if (heroImage) {
    if (heroImage.imageType === "upload" && heroImage.uploadedImage) {
      return heroImage.uploadedImage;
    }
    if (heroImage.imageType === "url" && heroImage.externalUrl) {
      return heroImage.externalUrl;
    }
  }

  if (image) {
    return image;
  }

  return null;
};

const imageSrc = getImageSrc();
const finalImageAlt = heroImage?.alt || imageAlt || title;
const imageCaption = heroImage?.caption;

const postDescription = description || excerpt || "";
const publishedTime = new Date(date).toISOString();
const formattedDate = new Date(date).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Get all posts for navigation
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const currentIndex = sortedPosts.findIndex((post) => post.slug === articleId);
const previousPost =
  currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

// Category color mapping
const getCategoryColor = (cat: string | undefined): string => {
  if (!cat) return "#6b7280";
  const colors: Record<string, string> = {
    "build-thinking": "#1A73E8",
    "learning-by-doing": "#EA4335",
    "product-lessons": "#10B981",
    "startup-insight": "#EF4444",
    "product-strategy": "#F59E0B",
    "fail-iterate-ship": "#FF6B35",
    "ai-evolution": "#8B5CF6",
    "developer-tools": "#06B6D4",
    "research-bites": "#EC4899",
    "global-perspective": "#9C27B0",
    "community-innovation": "#10B981",
    "tech-culture": "#EC4899",
    "system-thinking": "#059669",
    "the-interface": "#3B82F6",
    "career-stacks": "#DC2626",
    "future-stacks": "#7C3AED",
    "creator-economy": "#F472B6",
    "business-models": "#6366F1",
    "business-models-monetization": "#6366F1",
    "consumer-behavior": "#0891B2",
    "consumer-behavior-attention": "#0891B2",
    "market-maps": "#059669",
    "ecosystem-shifts-market-maps": "#059669",
    "people-systems": "#EA580C",
    "no-fluff-coverage": "#FF9800",
    "research-backed": "#FBBC04",
    "build-loop": "#FF6B35",
  };

  const normalizedCat = cat
    ?.toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^\w-]/g, "");
  return colors[normalizedCat] || "#6b7280";
};

const categoryColor = getCategoryColor(category);
const formatCategory = (cat: string | undefined): string => {
  if (!cat) return "ARTICLE";
  return cat.replace(/-/g, " ").toUpperCase();
};

const getAuthorName = (postData: any): string => {
  try {
    if (postData?.data?.authorInfo?.name) {
      return postData.data.authorInfo.name;
    }
    if (postData?.data?.author) {
      return postData.data.author;
    }
    return "TinkByte Team";
  } catch (error) {
    return "TinkByte Team";
  }
};

// Make TinaCMS components available for MDX
if (typeof globalThis !== "undefined") {
  globalThis.ImageBlock = ImageBlock;
  globalThis.VideoBlock = VideoBlock;
  globalThis.Callout = CalloutBox;
  globalThis.ButtonBlock = ButtonBlock;
  globalThis.CodeBlock = CodeBlock;
  globalThis.Quote = Quote;
  globalThis.TableBlock = TableBlock;
  globalThis.ImageGallery = ImageGallery;
  globalThis.Newsletter = Newsletter;
  globalThis.TwoColumnLayout = TwoColumnLayout;
}
---

<Layout
  title={title}
  description={postDescription}
  type="article"
  publishedTime={publishedTime}
  author={authorData.name}
  tags={tags}
  image={imageSrc || undefined}
>
  <!-- Reading Progress Bar -->
  {
    showReadingProgress && (
      <div id="reading-progress" class="reading-progress">
        <div class="reading-progress-bar" />
      </div>
    )
  }

  <script>
    // Suppress ad blocker console errors
    window.addEventListener("error", function (e) {
      if (
        e.message &&
        (e.message.includes("doubleclick") || e.message.includes("googleads"))
      ) {
        e.preventDefault();
        return false;
      }
    });
  </script>

  <MDXProvider>
    <article
      class="magazine-article theme-bg-primary"
      data-article-id={articleId}
      data-article-title={title}
    >
      <!-- FIXED: Much lighter overlay and proper spacing -->
      <header class="article-header-integrated">
        <!-- VERY LIGHT background gradient overlay -->
        <div class="header-gradient-overlay-light"></div>

        <!-- Hero image as background with MINIMAL overlay -->
        {
          imageSrc && (
            <div class="hero-background-container">
              <Image
                src={imageSrc}
                alt={finalImageAlt}
                width={1200}
                height={600}
                class="hero-background-image"
                format="webp"
                loading="eager"
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
              />
              <div class="hero-image-overlay-light" />
            </div>
          )
        }

        <div class="max-w-7xl mx-auto px-4 py-6 relative z-10">
          <!-- Compact Meta Line -->
          <div class="article-meta-compact">
            <div class="meta-badges-row">
              <span
                class="category-tag-compact"
                style={`background: ${categoryColor}; color: white;`}
                data-tina-field="category"
              >
                {formatCategory(category)}
              </span>

              {
                audioUrl && (
                  <span class="audio-badge-compact" data-tina-field="audioUrl">
                    <i class="fas fa-headphones mr-1" />
                    AUDIO
                  </span>
                )
              }

              <time
                datetime={publishedTime}
                class="article-date-compact"
                data-tina-field="pubDate"
              >
                {formattedDate}
              </time>
            </div>
          </div>

          <!-- Compact Title Section -->
          <div class="article-header-content-compact">
            <h1 class="article-title-compact" data-tina-field="title">
              {title}
            </h1>

            {
              subtitle && (
                <h2 class="article-subtitle-compact" data-tina-field="subtitle">
                  {subtitle}
                </h2>
              )
            }

            {
              postDescription && (
                <p
                  class="article-description-compact"
                  data-tina-field="excerpt"
                >
                  {postDescription}
                </p>
              )
            }

            <!-- Clean Author Line (No Border, Clean Icons) -->
            <div class="article-byline-compact">
              <div class="author-compact" data-tina-field="authorInfo">
                {
                  authorData.avatar && (
                    <Image
                      src={authorData.avatar}
                      alt={`${authorData.name} profile picture`}
                      width={24}
                      height={24}
                      class="author-avatar-compact"
                      format="webp"
                      loading="eager"
                    />
                  )
                }
                <span class="author-name-compact">By {authorData.name}</span>
              </div>

              <div class="meta-compact-right">
                {
                  readTime && (
                    <span class="read-time-compact" data-tina-field="readTime">
                      {readTime}
                    </span>
                  )
                }
                <div class="share-compact-clean">
                  <button class="share-icon-clean" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                  </button>
                  <button class="share-icon-clean" data-platform="linkedin">
                    <i class="fab fa-linkedin"></i>
                  </button>
                  <button class="share-icon-clean" data-platform="copy">
                    <i class="fas fa-link"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- FIXED: Much lower positioned overlapping image -->
      {
        imageSrc && (
          <div class="article-image-overlap-fixed">
            <div class="max-w-7xl mx-auto px-4">
              <div class="image-card-overlap">
                <Image
                  src={imageSrc}
                  alt={finalImageAlt}
                  width={1200}
                  height={600}
                  class="article-image-card"
                  format="webp"
                  loading="eager"
                  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
                />
                {imageCaption ? (
                  <div class="image-caption-overlay">{imageCaption}</div>
                ) : (
                  <div class="image-caption-overlay">
                    Photo by TinkByte Team
                  </div>
                )}
              </div>
            </div>
          </div>
        )
      }

      <!-- Keep all your existing audio, content, sidebar, navigation code exactly the same -->
      <!-- Audio Player Section -->
      {
        audioUrl ? (
          <div class="audio-section-enhanced">
            <div class="max-w-7xl mx-auto px-4">
              <div class="audio-container">
                <div class="audio-header">
                  <h3 class="audio-title">
                    <i class="fas fa-headphones mr-3" />
                    Listen to this article
                  </h3>
                  <p class="audio-subtitle">
                    Perfect for multitasking or commuting
                  </p>
                </div>
                <AudioPlayer
                  audioUrl={audioUrl}
                  title={title}
                  duration={audioDuration}
                />
              </div>
            </div>
          </div>
        ) : (
          <div class="no-audio-section-enhanced">
            <div class="max-w-7xl mx-auto px-4">
              <div class="no-audio-placeholder-enhanced">
                <div class="no-audio-content">
                  <svg
                    class="audio-icon-enhanced"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                    />
                  </svg>
                  <div>
                    <span class="no-audio-text-enhanced">
                      Audio version coming soon
                    </span>
                    <p class="no-audio-subtitle-enhanced">
                      Reading time: {readTime || "5 min"}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      }

      <!-- Article Content Grid -->
      <div class="article-content-wrapper-enhanced">
        <div class="max-w-7xl mx-auto px-4">
          <div class="content-grid-enhanced">
            <!-- Main Content -->
            <div class="content-main-enhanced" data-tina-field="body">
              <slot />
            </div>

            <!-- Enhanced Sidebar -->
            <aside class="content-sidebar-enhanced">
              <!-- Table of Contents -->
              <div
                class="sidebar-section-enhanced"
                id="toc-section"
                style="display: none;"
              >
                <h4 class="sidebar-title-enhanced">
                  <i class="fas fa-list mr-2"></i>
                  Contents
                </h4>
                <div id="table-of-contents" class="toc-container-enhanced">
                  <!-- TOC will be generated here by JavaScript -->
                </div>
              </div>

              <!-- Share buttons -->
              <div class="sidebar-section-enhanced">
                <h4 class="sidebar-title-enhanced">
                  <i class="fas fa-share-alt mr-2"></i>
                  Share Article
                </h4>
                <ShareButtons
                  title={title}
                  url={`${SITE.url}/blog/${articleId}`}
                />
              </div>

              <!-- Author Bio Section -->
              {
                authorData && authorData.name && (
                  <div class="sidebar-section-enhanced">
                    <h4 class="sidebar-title-enhanced">
                      <i class="fas fa-user mr-2" />
                      About the Author
                    </h4>
                    <AuthorBio author={authorData} />
                  </div>
                )
              }

              <!-- Tags -->
              {
                tags && tags.length > 0 && (
                  <div class="sidebar-section-enhanced">
                    <h4 class="sidebar-title-enhanced">
                      <i class="fas fa-tags mr-2" />
                      Topics
                    </h4>
                    <div class="tag-list-enhanced">
                      {tags.map((tag) => (
                        <a
                          href={`/blog/tags/${tag.toLowerCase().replace(/\s+/g, "-")}`}
                          class="tag-link-enhanced"
                        >
                          #{tag}
                        </a>
                      ))}
                    </div>
                  </div>
                )
              }

              <!-- Reading Progress Indicator -->
              <div class="sidebar-section-enhanced">
                <h4 class="sidebar-title-enhanced">
                  <i class="fas fa-book-reader mr-2"></i>
                  Reading Progress
                </h4>
                <div class="progress-indicator">
                  <div class="progress-circle">
                    <svg class="progress-ring" width="60" height="60">
                      <circle
                        class="progress-ring-circle"
                        stroke="currentColor"
                        stroke-width="4"
                        fill="transparent"
                        r="26"
                        cx="30"
                        cy="30"
                        style="stroke-dasharray: 163.36; stroke-dashoffset: 163.36;"
                      ></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        </div>

        <!-- Keep all your existing navigation, comments, related posts code -->
        <!-- Floating Reaction Bar -->
        <ReactionBar postSlug={articleId} postTitle={title} />

        <!-- Navigation -->
        <div class="post-navigation-enhanced">
          <div class="max-w-7xl mx-auto px-4 py-12">
            <div class="nav-header">
              <h3 class="nav-section-title">Continue Reading</h3>
              <p class="nav-section-subtitle">
                Explore more insights from TinkByte
              </p>
            </div>

            <FeedbackWidget
              position="bottom-right"
              theme="auto"
              hideOnPages={["/admin"]}
            />

            <div class="nav-grid-enhanced">
              {
                previousPost ? (
                  <a
                    href={`/blog/${previousPost.slug}`}
                    class="nav-link-enhanced nav-previous-enhanced"
                  >
                    <div class="nav-direction-enhanced">
                      <i class="fas fa-arrow-left mr-2" />
                      Previous Article
                    </div>
                    <div class="nav-title-enhanced">
                      {previousPost.data.title}
                    </div>
                    <div class="nav-meta-enhanced">
                      By {getAuthorName(previousPost)}
                    </div>
                  </a>
                ) : (
                  <div class="nav-placeholder-enhanced">
                    <div class="nav-placeholder-content">
                      <i class="fas fa-home text-2xl mb-2" />
                      <span>You've reached the beginning</span>
                      <a href="/blog" class="nav-home-link">
                        Browse All Articles
                      </a>
                    </div>
                  </div>
                )
              }

              {
                nextPost ? (
                  <a
                    href={`/blog/${nextPost.slug}`}
                    class="nav-link-enhanced nav-next-enhanced"
                  >
                    <div class="nav-direction-enhanced">
                      Next Article
                      <i class="fas fa-arrow-right ml-2" />
                    </div>
                    <div class="nav-title-enhanced">{nextPost.data.title}</div>
                    <div class="nav-meta-enhanced">
                      By {getAuthorName(nextPost)}
                    </div>
                  </a>
                ) : (
                  <div class="nav-placeholder-enhanced">
                    <div class="nav-placeholder-content">
                      <i class="fas fa-flag-checkered text-2xl mb-2" />
                      <span>You've read it all!</span>
                      <a href="/blog" class="nav-home-link">
                        Browse All Articles
                      </a>
                    </div>
                  </div>
                )
              }
            </div>

            <!-- Enhanced Comments Section -->
            <div class="comments-section-wrapper">
              <div class="comments-container-enhanced">
                <TinkByteCommentSection
                  articleId={articleId}
                  postSlug={articleId}
                  postTitle={title}
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Related Posts -->
        <div class="related-section-enhanced">
          <div class="max-w-7xl mx-auto px-4 py-12">
            <div class="related-header">
              <h3 class="related-title">More from TinkByte</h3>
              <p class="related-subtitle">
                Discover more insights that matter to builders
              </p>
            </div>
            <RelatedPosts currentSlug={articleId} />
          </div>
        </div>
      </div>
    </article>
  </MDXProvider>
</Layout>

<style>
  /* CSS Custom Properties for Perfect Square Design */
  :root {
    --tinkbyte-radius: 0px;
    --tinkbyte-radius-sm: 0px;
    --tinkbyte-radius-md: 0px;
    --tinkbyte-radius-lg: 0px;
    --tinkbyte-radius-card: 12px;
    --tinkbyte-radius-button: 6px;
  }

  /* Reading Progress Bar Styles */
  .reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.05);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .reading-progress.visible {
    opacity: 1;
  }

  .reading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #2563eb, #0891b2);
    width: 0%;
    transition: width 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 8px rgba(37, 99, 235, 0.2);
  }

  /* Base transitions for all elements */
  :global(*),
  :global(*::before),
  :global(*::after) {
    transition:
      background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      stroke 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Enhanced Magazine Design System */
  .magazine-article {
    background: white;
    min-height: 100vh;
  }

  .theme-bg-primary {
    background-color: var(--color-bg-primary) !important;
  }

  :global(.dark) .magazine-article {
    background: rgb(17, 24, 39);
  }

  /* FIXED: Your exact original brand colors */
  .article-header-integrated {
    position: relative;
    background: linear-gradient(
      135deg,
      #f8fafc 0%,
      #f1f5f9 100%
    ); /* Your original light gradient */
    border-bottom: 1px solid #e2e8f0;
    min-height: auto;
    display: block;
    padding: 2rem 0;
    overflow: visible;
  }

  :global(.dark) .article-header-integrated {
    background: linear-gradient(
      135deg,
      rgb(15, 23, 42) 0%,
      rgb(30, 41, 59) 100%
    ); /* Your original dark gradient */
    border-bottom-color: rgb(51, 65, 85);
  }

  /* REMOVE: No background image in header */
  .hero-background-container {
    display: none; /* COMPLETELY REMOVE from header */
  }

  .hero-background-image {
    display: none; /* COMPLETELY REMOVE from header */
  }

  /* REMOVE: No overlay in header */
  .header-gradient-overlay-light {
    display: none; /* COMPLETELY REMOVE */
  }

  .hero-image-overlay-light {
    display: none; /* COMPLETELY REMOVE */
  }

  /* Compact Meta Badges */
  .article-meta-compact {
    margin-bottom: 1rem;
    position: relative;
    z-index: auto;
  }

  .meta-badges-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .category-tag-compact {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.5rem 1rem;
    border-radius: var(--tinkbyte-radius-button);
    display: flex;
    align-items: center;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .audio-badge-compact {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border-radius: var(--tinkbyte-radius-button);
    display: flex;
    align-items: center;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }

  .article-date-compact {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 500;
    background: rgba(100, 116, 139, 0.1);
    padding: 0.5rem 0.75rem;
    border-radius: var(--tinkbyte-radius-button);
    backdrop-filter: blur(10px);
    white-space: nowrap;
    border: 1px solid rgba(100, 116, 139, 0.2);
    position: relative;
    z-index: auto;
  }

  :global(.dark) .article-date-compact {
    color: rgb(148, 163, 184);
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.2);
  }

  /* Header content positioned normally */
  .article-header-content-compact {
    color: rgb(15, 23, 42);
    margin-top: 1rem;
    position: relative;
    z-index: auto;
  }

  :global(.dark) .article-header-content-compact {
    color: rgb(248, 250, 252);
  }

  .article-title-compact {
    font-family: "Space Grotesk", sans-serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    line-height: 1.1;
    margin-bottom: 1rem;
    position: relative;
    z-index: auto;
    background: linear-gradient(
      135deg,
      rgb(15, 23, 42) 0%,
      rgb(30, 58, 138) 100%
    );
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  :global(.dark) .article-title-compact {
    background: linear-gradient(
      135deg,
      rgb(248, 250, 252) 0%,
      rgb(147, 197, 253) 100%
    );
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .article-subtitle-compact {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.3;
    color: #475569;
    margin-bottom: 1rem;
    position: relative;
    z-index: auto;
  }

  :global(.dark) .article-subtitle-compact {
    color: rgb(148, 163, 184);
  }

  .article-description-compact {
    font-size: 1.125rem;
    line-height: 1.5;
    color: #64748b;
    margin-bottom: 1.5rem;
    position: relative;
    z-index: auto;
  }

  :global(.dark) .article-description-compact {
    color: rgb(156, 163, 175);
  }

  /* Clean Author Line - No borders, clean design */
  .article-byline-compact {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    gap: 1rem;
    flex-wrap: nowrap;
    position: relative;
    z-index: auto;
  }

  .author-compact {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .author-avatar-compact {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(100, 116, 139, 0.3);
  }

  :global(.dark) .author-avatar-compact {
    border-color: rgba(148, 163, 184, 0.3);
  }

  .author-name-compact {
    font-weight: 600;
    color: rgb(15, 23, 42);
    font-size: 0.875rem;
    white-space: nowrap;
    position: relative;
    z-index: auto;
  }

  :global(.dark) .author-name-compact {
    color: rgb(248, 250, 252);
  }

  .meta-compact-right {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
  }

  .read-time-compact {
    font-size: 0.8125rem;
    color: #64748b;
    font-weight: 600;
    white-space: nowrap;
    position: relative;
    z-index: auto;
  }

  :global(.dark) .read-time-compact {
    color: rgb(148, 163, 184);
  }

  /* CLEAN SHARE ICONS - No borders, no backgrounds */
  .share-compact-clean {
    display: flex;
    gap: 0.75rem;
  }

  .share-icon-clean {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    transition: all 0.2s ease;
    border-radius: 0;
  }

  .share-icon-clean i {
    color: #64748b;
    font-size: 1rem;
    position: relative;
    z-index: auto;
  }

  :global(.dark) .share-icon-clean i {
    color: rgb(148, 163, 184);
  }

  .share-icon-clean:hover i {
    color: rgb(30, 58, 138);
    transform: scale(1.1);
  }

  :global(.dark) .share-icon-clean:hover i {
    color: rgb(147, 197, 253);
  }

  /* FIXED: Hero image moves up slightly as marked */
  .article-image-overlap-fixed {
    position: relative;
    z-index: auto;
    margin-top: -1rem; /* Move up slightly as you marked */
    margin-bottom: 4rem;
  }

  .image-card-overlap {
    position: relative;
    border-radius: var(--tinkbyte-radius-card);
    overflow: hidden;
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 0 1px rgba(255, 255, 255, 0.1);
    aspect-ratio: 16/9;
    background: white;
  }

  :global(.dark) .image-card-overlap {
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.5),
      0 0 0 1px rgba(255, 255, 255, 0.1);
    background: rgb(17, 24, 39);
  }

  .article-image-card {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .image-caption-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    padding: 2rem 1.5rem 1.5rem;
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
  }

  /* Audio Section */
  .audio-section-enhanced {
    margin: 1rem 0;
  }

  .audio-container {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0ea5e9;
    border-radius: var(--tinkbyte-radius-card);
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(14, 165, 233, 0.1);
  }

  :global(.dark) .audio-container {
    background: linear-gradient(
      135deg,
      rgb(12, 74, 110) 0%,
      rgb(15, 118, 110) 100%
    );
    border-color: rgb(34, 197, 94);
  }

  .audio-header {
    margin-bottom: 1.5rem;
  }

  .audio-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0c4a6e;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
  }

  :global(.dark) .audio-title {
    color: rgb(125, 211, 252);
  }

  .audio-subtitle {
    color: #0369a1;
    font-size: 0.875rem;
  }

  :global(.dark) .audio-subtitle {
    color: rgb(186, 230, 253);
  }

  /* No Audio Section */
  .no-audio-section-enhanced {
    margin: 1rem 0;
  }

  .no-audio-placeholder-enhanced {
    background: #f8fafc;
    border: 2px dashed #cbd5e1;
    border-radius: var(--tinkbyte-radius-card);
    padding: 2rem;
  }

  :global(.dark) .no-audio-placeholder-enhanced {
    background: rgb(30, 41, 59);
    border-color: rgb(71, 85, 105);
  }

  .no-audio-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    justify-content: center;
    text-align: center;
  }

  .audio-icon-enhanced {
    width: 2.5rem;
    height: 2.5rem;
    color: #94a3b8;
  }

  :global(.dark) .audio-icon-enhanced {
    color: rgb(100, 116, 139);
  }

  .no-audio-text-enhanced {
    font-size: 1rem;
    font-weight: 600;
    color: #475569;
  }

  :global(.dark) .no-audio-text-enhanced {
    color: rgb(148, 163, 184);
  }

  .no-audio-subtitle-enhanced {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0.5rem 0 0 0;
  }

  :global(.dark) .no-audio-subtitle-enhanced {
    color: rgb(100, 116, 139);
  }

  /* Content Grid */
  .article-content-wrapper-enhanced {
    padding: 2rem 0;
  }

  .content-grid-enhanced {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 3rem;
    align-items: start;
  }

  /* Main Content */
  .content-main-enhanced {
    font-size: 1.125rem;
    line-height: 1.7;
    color: #374151;
  }

  :global(.dark) .content-main-enhanced {
    color: rgb(209, 213, 219);
  }

  .content-main-enhanced :global(h1) {
    font-family: "Space Grotesk", sans-serif;
    font-size: 2.5rem;
    font-weight: 800;
    color: rgb(15, 23, 42);
    margin: 2rem 0 1rem;
    line-height: 1.2;
  }

  .content-main-enhanced :global(h2) {
    font-family: "Space Grotesk", sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: rgb(30, 58, 138);
    margin: 2rem 0 1rem;
    line-height: 1.2;
    position: relative;
    padding-left: 1rem;
  }

  .content-main-enhanced :global(h2::before) {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(135deg, rgb(59, 130, 246), rgb(147, 51, 234));
    border-radius: var(--tinkbyte-radius-sm);
  }

  .content-main-enhanced :global(h3) {
    font-family: "Space Grotesk", sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: rgb(51, 65, 85);
    margin: 2rem 0 1rem;
    line-height: 1.4;
  }

  .content-main-enhanced :global(p) {
    margin-bottom: 1.5rem;
    text-align: justify;
  }

  .content-main-enhanced :global(a) {
    color: rgb(59, 130, 246);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .content-main-enhanced :global(a:hover) {
    color: rgb(37, 99, 235);
    border-bottom-color: rgb(37, 99, 235);
    background: rgba(59, 130, 246, 0.1);
    padding: 0 2px;
    border-radius: var(--tinkbyte-radius-sm);
  }

  /* Sidebar */
  .content-sidebar-enhanced {
    position: sticky;
    top: 2rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 2px solid #e2e8f0;
    padding: 2.5rem;
    border-radius: var(--tinkbyte-radius-card);
    height: fit-content;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  :global(.dark) .content-sidebar-enhanced {
    background: linear-gradient(
      135deg,
      rgb(30, 41, 59) 0%,
      rgb(51, 65, 85) 100%
    );
    border-color: rgb(71, 85, 105);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  .sidebar-section-enhanced {
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .sidebar-section-enhanced:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  :global(.dark) .sidebar-section-enhanced {
    border-bottom-color: rgb(71, 85, 105);
  }

  .sidebar-title-enhanced {
    font-size: 1rem;
    font-weight: 700;
    color: rgb(30, 58, 138);
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
  }

  :global(.dark) .sidebar-title-enhanced {
    color: rgb(147, 197, 253);
  }

  /* Tags */
  .tag-list-enhanced {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .tag-link-enhanced {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: var(--tinkbyte-radius-button);
    text-decoration: none;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.2s ease;
  }

  :global(.dark) .tag-link-enhanced {
    background: rgb(17, 24, 39);
    border-color: rgb(71, 85, 105);
    color: rgb(148, 163, 184);
  }

  .tag-link-enhanced:hover {
    border-color: rgb(59, 130, 246);
    color: rgb(30, 58, 138);
    background: rgba(59, 130, 246, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
  }

  /* Reading Progress */
  .progress-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .progress-circle {
    position: relative;
    width: 60px;
    height: 60px;
  }

  .progress-ring {
    transform: rotate(-90deg);
  }

  .progress-ring-circle {
    stroke: #e2e8f0;
    transition: stroke-dashoffset 0.3s ease;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 700;
    color: #475569;
  }

  :global(.dark) .progress-text {
    color: rgb(148, 163, 184);
  }

  /* Navigation */
  .post-navigation-enhanced {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-top: 2px solid #e2e8f0;
  }

  :global(.dark) .post-navigation-enhanced {
    background: linear-gradient(
      135deg,
      rgb(15, 23, 42) 0%,
      rgb(30, 41, 59) 100%
    );
    border-top-color: rgb(51, 65, 85);
  }

  .nav-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .nav-section-title {
    font-size: 2rem;
    font-weight: 700;
    color: rgb(15, 23, 42);
    margin-bottom: 0.5rem;
  }

  :global(.dark) .nav-section-title {
    color: rgb(248, 250, 252);
  }

  .nav-section-subtitle {
    color: #64748b;
    font-size: 1rem;
  }

  :global(.dark) .nav-section-subtitle {
    color: rgb(148, 163, 184);
  }

  .nav-grid-enhanced {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
  }

  .nav-link-enhanced {
    display: block;
    padding: 2.5rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: var(--tinkbyte-radius-card);
    text-decoration: none;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  :global(.dark) .nav-link-enhanced {
    background: rgb(30, 41, 59);
    border-color: rgb(71, 85, 105);
  }

  .nav-link-enhanced:hover {
    border-color: rgb(59, 130, 246);
    transform: translateY(-4px);
    box-shadow: 0 10px 40px rgba(59, 130, 246, 0.2);
  }

  .nav-previous-enhanced {
    text-align: left;
  }

  .nav-next-enhanced {
    text-align: right;
  }

  .nav-direction-enhanced {
    font-size: 0.875rem;
    font-weight: 700;
    color: rgb(59, 130, 246);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
  }

  .nav-next-enhanced .nav-direction-enhanced {
    justify-content: flex-end;
  }

  .nav-title-enhanced {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0f172a;
    line-height: 1.4;
    margin-bottom: 1rem;
  }

  :global(.dark) .nav-title-enhanced {
    color: rgb(248, 250, 252);
  }

  .nav-meta-enhanced {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
  }

  :global(.dark) .nav-meta-enhanced {
    color: rgb(148, 163, 184);
  }

  .nav-placeholder-enhanced {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2.5rem;
    background: #f8fafc;
    border: 2px dashed #cbd5e1;
    border-radius: var(--tinkbyte-radius-card);
  }

  :global(.dark) .nav-placeholder-enhanced {
    background: rgb(51, 65, 85);
    border-color: rgb(100, 116, 139);
  }

  .nav-placeholder-content {
    text-align: center;
    color: #64748b;
  }

  :global(.dark) .nav-placeholder-content {
    color: rgb(148, 163, 184);
  }

  .nav-home-link {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background: rgb(59, 130, 246);
    color: white;
    text-decoration: none;
    border-radius: var(--tinkbyte-radius-button);
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .nav-home-link:hover {
    background: rgb(37, 99, 235);
    transform: translateY(-2px);
  }

  /* Comments Section */
  .comments-section-wrapper {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-top: 2px solid #e2e8f0;
    margin-top: 0;
  }

  :global(.dark) .comments-section-wrapper {
    background: linear-gradient(
      135deg,
      rgb(15, 23, 42) 0%,
      rgb(30, 41, 59) 100%
    );
    border-top-color: rgb(51, 65, 85);
  }

  .comments-container-enhanced {
    background: white;
    border-radius: var(--tinkbyte-radius-card);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    border: 2px solid #e2e8f0;
    max-width: 1200px;
    margin: 0 auto;
  }

  :global(.dark) .comments-container-enhanced {
    background: rgb(17, 24, 39);
    border-color: rgb(55, 65, 81);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  /* Related Section */
  .related-section-enhanced {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-top: 2px solid #e2e8f0;
  }

  :global(.dark) .related-section-enhanced {
    background: linear-gradient(
      135deg,
      rgb(15, 23, 42) 0%,
      rgb(30, 41, 59) 100%
    );
    border-top-color: rgb(51, 65, 85);
  }

  .related-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .related-title {
    font-size: 2rem;
    font-weight: 700;
    color: rgb(15, 23, 42);
    margin-bottom: 0.5rem;
  }

  :global(.dark) .related-title {
    color: rgb(248, 250, 252);
  }

  .related-subtitle {
    color: #64748b;
    font-size: 1rem;
  }

  :global(.dark) .related-subtitle {
    color: rgb(148, 163, 184);
  }

  /* TOC Styles */
  .toc-container-enhanced {
    max-height: 300px;
    overflow-y: auto;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-list li {
    margin-bottom: 0.5rem;
  }

  .toc-link {
    display: block;
    padding: 0.5rem 0.75rem;
    color: #64748b;
    text-decoration: none;
    border-radius: var(--tinkbyte-radius-sm);
    font-size: 0.875rem;
    line-height: 1.4;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
  }

  .toc-link:hover {
    background: rgba(59, 130, 246, 0.1);
    color: rgb(30, 58, 138);
    border-left-color: rgb(59, 130, 246);
  }

  .toc-link.active {
    background: rgba(59, 130, 246, 0.15);
    color: rgb(30, 58, 138);
    border-left-color: rgb(59, 130, 246);
    font-weight: 600;
  }

  .toc-h3 {
    margin-left: 1rem;
    font-size: 0.8rem;
  }

  :global(.dark) .toc-link {
    color: rgb(148, 163, 184);
  }

  :global(.dark) .toc-link:hover {
    background: rgba(59, 130, 246, 0.2);
    color: rgb(147, 197, 253);
  }

  :global(.dark) .toc-link.active {
    background: rgba(59, 130, 246, 0.25);
    color: rgb(147, 197, 253);
  }

  /* Mobile Responsive Adjustments */
  @media (max-width: 1024px) {
    .content-grid-enhanced {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .content-sidebar-enhanced {
      position: static;
      order: -1;
      margin-bottom: 2rem;
      padding: 1.5rem;
    }

    .nav-grid-enhanced {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .nav-next-enhanced,
    .nav-previous-enhanced {
      text-align: left;
    }

    .nav-next-enhanced .nav-direction-enhanced {
      justify-content: flex-start;
    }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .magazine-article {
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }

    .article-header-integrated {
      padding: 1.5rem 0;
    }

    .max-w-7xl {
      max-width: 100%;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .article-header-content-compact {
      text-align: left;
    }

    .article-title-compact {
      font-size: clamp(1.75rem, 6vw, 2.5rem);
      line-height: 1.2;
      margin-bottom: 0.75rem;
    }

    .article-subtitle-compact {
      font-size: 1.125rem;
      margin-bottom: 0.75rem;
    }

    .article-description-compact {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .meta-badges-row {
      justify-content: flex-start;
      gap: 0.5rem;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .category-tag-compact {
      font-size: 0.6875rem;
      padding: 0.375rem 0.75rem;
      flex-shrink: 0;
    }

    .audio-badge-compact {
      font-size: 0.6875rem;
      padding: 0.375rem 0.625rem;
      flex-shrink: 0;
    }

    .article-date-compact {
      font-size: 0.6875rem;
      padding: 0.375rem 0.625rem;
      flex-shrink: 0;
    }

    .article-byline-compact {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding-top: 0.75rem;
      flex-wrap: nowrap;
    }

    .author-compact {
      flex-direction: row;
      gap: 0.5rem;
      align-items: center;
      flex-shrink: 1;
      min-width: 0;
    }

    .author-name-compact {
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta-compact-right {
      flex-direction: row;
      gap: 0.75rem;
      align-items: center;
      flex-shrink: 0;
    }

    .read-time-compact {
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .share-compact-clean {
      gap: 0.5rem;
    }

    .share-icon-clean {
      padding: 0.25rem;
    }

    .share-icon-clean i {
      font-size: 0.875rem;
    }

    .article-image-overlap-fixed {
      margin-top: -2rem; /* Less overlap on mobile */
      margin-bottom: 2rem;
    }

    .image-card-overlap {
      border-radius: 8px;
      aspect-ratio: 16/10;
    }

    .content-sidebar-enhanced {
      display: none !important;
    }

    .content-main-enhanced {
      font-size: 1rem;
      line-height: 1.6;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .audio-section-enhanced,
    .no-audio-section-enhanced {
      margin: 1rem 0;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .audio-container,
    .no-audio-placeholder-enhanced {
      padding: 1.5rem;
    }

    .article-content-wrapper-enhanced {
      padding: 1.5rem 0;
    }
  }

  @media (max-width: 480px) {
    .article-header-integrated {
      padding: 1rem 0;
    }

    .article-title-compact {
      font-size: clamp(1.5rem, 5vw, 2rem);
    }

    .meta-badges-row {
      gap: 0.375rem;
    }

    .category-tag-compact,
    .audio-badge-compact,
    .article-date-compact {
      font-size: 0.625rem;
      padding: 0.25rem 0.5rem;
    }

    .article-image-overlap-fixed {
      margin-top: -1rem; /* Minimal overlap on small screens */
      margin-bottom: 1.5rem;
    }

    .nav-link-enhanced {
      padding: 1.5rem;
    }

    .audio-container,
    .no-audio-placeholder-enhanced {
      padding: 1rem;
    }

    .comments-container-enhanced {
      margin-left: 0;
      margin-right: 0;
    }

    .author-name-compact {
      font-size: 0.6875rem;
    }

    .read-time-compact {
      font-size: 0.6875rem;
    }

    .share-icon-clean i {
      font-size: 0.8125rem;
    }
  }

  /* Prevent horizontal overflow */
  @media (max-width: 768px) {
    * {
      max-width: 100%;
      box-sizing: border-box;
    }

    p,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    span,
    div {
      overflow-wrap: break-word;
      word-wrap: break-word;
      hyphens: auto;
    }

    pre,
    code {
      max-width: 100%;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .reading-progress,
    .reading-progress-bar,
    .progress-ring-circle,
    .nav-link-enhanced,
    .tag-link-enhanced,
    .share-icon-clean {
      transition: none;
    }
  }
</style>

<script define:vars={{ articleSlug: articleId }}>
  document.addEventListener("DOMContentLoaded", async function () {
    const articleElement = document.querySelector("article");
    const articleIdFromElement =
      articleElement?.getAttribute("data-article-id");
    const articleIdFromVar = articleSlug;

    const currentArticleId =
      articleIdFromElement || articleIdFromVar || "unknown-article";

    window.currentArticleId = currentArticleId;

    if (!currentArticleId || currentArticleId === "unknown-article") {
      console.warn("No valid article ID found, skipping activity tracking");
      return;
    }

    function initTopReadingProgress() {
      const progressContainer = document.querySelector(".reading-progress");
      const progressBar = document.querySelector(".reading-progress-bar");

      if (!progressContainer || !progressBar) {
        return;
      }

      let ticking = false;

      function updateTopProgress() {
        const scrollTop =
          window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight =
          document.documentElement.scrollHeight - window.innerHeight;
        const progress =
          scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;

        if (scrollTop > 50) {
          progressContainer.classList.add("visible");
        } else {
          progressContainer.classList.remove("visible");
        }

        const clampedProgress = Math.min(Math.max(progress, 0), 100);
        progressBar.style.width = `${clampedProgress}%`;

        ticking = false;
      }

      function requestTick() {
        if (!ticking) {
          requestAnimationFrame(updateTopProgress);
          ticking = true;
        }
      }

      window.addEventListener("scroll", requestTick, { passive: true });
      window.addEventListener("resize", requestTick, { passive: true });
      updateTopProgress();
    }

    function initSidebarReadingProgress() {
      const progressRing = document.querySelector(".progress-ring-circle");
      const progressText = document.querySelector(".progress-text");

      if (!progressRing || !progressText) {
        return;
      }

      const radius = 26;
      const circumference = radius * 2 * Math.PI;
      progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
      progressRing.style.strokeDashoffset = circumference.toString();

      function updateSidebarProgress() {
        const scrollTop =
          window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight =
          document.documentElement.scrollHeight - window.innerHeight;
        const progress =
          scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;

        const clampedProgress = Math.min(Math.max(progress, 0), 100);
        const offset = circumference - (clampedProgress / 100) * circumference;

        progressRing.style.strokeDashoffset = offset.toString();
        progressRing.style.stroke =
          clampedProgress > 0 ? "rgb(59, 130, 246)" : "#e2e8f0";
        progressText.textContent = Math.round(clampedProgress) + "%";
      }

      let ticking = false;
      function handleScroll() {
        if (!ticking) {
          requestAnimationFrame(() => {
            updateSidebarProgress();
            ticking = false;
          });
          ticking = true;
        }
      }

      window.addEventListener("scroll", handleScroll, { passive: true });
      window.addEventListener("resize", handleScroll, { passive: true });
      updateSidebarProgress();
    }

    initTopReadingProgress();
    initSidebarReadingProgress();

    function generateTOC() {
      const headings = document.querySelectorAll(
        ".content-main-enhanced h2, .content-main-enhanced h3"
      );
      const tocSection = document.getElementById("toc-section");
      const tocContainer = document.getElementById("table-of-contents");

      if (headings.length >= 3 && tocSection && tocContainer) {
        tocSection.style.display = "block";
        const tocList = document.createElement("ul");
        tocList.className = "toc-list";

        headings.forEach((heading, i) => {
          const id = `heading-${i}`;
          heading.id = id;

          const listItem = document.createElement("li");
          const link = document.createElement("a");
          link.href = `#${id}`;
          const headingText = heading.textContent || "";
          link.textContent =
            headingText.slice(0, 60) + (headingText.length > 60 ? "..." : "");
          link.className = `toc-link ${heading.tagName === "H3" ? "toc-h3" : ""}`;

          link.addEventListener("click", function (e) {
            e.preventDefault();
            const targetId = this.getAttribute("href")?.substring(1);
            const targetHeading = targetId
              ? document.getElementById(targetId)
              : null;
            if (targetHeading) {
              targetHeading.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }

            document.querySelectorAll(".toc-link").forEach((tocLink) => {
              tocLink.classList.remove("active");
            });
            this.classList.add("active");
          });

          listItem.appendChild(link);
          tocList.appendChild(listItem);
        });

        tocContainer.appendChild(tocList);
      }
    }

    // Enhanced share functionality for CLEAN buttons
    document.querySelectorAll(".share-icon-clean").forEach((icon) => {
      icon.addEventListener("click", async (e) => {
        const target = e.currentTarget;
        if (!target) return;

        const platform = target.getAttribute("data-platform");
        const url = window.location.href;
        const title = document.title;

        switch (platform) {
          case "twitter":
            window.open(
              `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`
            );
            break;
          case "linkedin":
            window.open(
              `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`
            );
            break;
          case "copy":
            try {
              await navigator.clipboard.writeText(url);
              const originalIcon = target.querySelector("i");
              if (originalIcon) {
                const originalClass = originalIcon.className;
                originalIcon.className = "fas fa-check";
                setTimeout(() => {
                  originalIcon.className = originalClass;
                }, 2000);
              }
            } catch (error) {
              console.error("Failed to copy URL:", error);
            }
            break;
        }
      });
    });

    setTimeout(generateTOC, 100);
  });

  document.addEventListener("astro:page-load", () => {
    setTimeout(() => {
      const event = new Event("DOMContentLoaded");
      document.dispatchEvent(event);
    }, 100);
  });

  document.addEventListener("astro:before-preparation", () => {
    const progressContainer = document.querySelector(".reading-progress");
    if (progressContainer) {
      progressContainer.classList.remove("visible");
    }
  });
</script>
