---
// src/components/comments/TinkByteCommentSection.astro
import { supabase } from "../../lib/supabase";
import {
  config,
  getCommentsReadEnvironments,
  getCommentsWriteEnvironment,
} from "../../lib/config";
import { COMMENT_CONFIG, REACTION_TYPES } from "../../lib/config/comments";
import { buildCommentTree } from "../../lib/helpers/commentHelpers";
import CommentCard from "./CommentCard.astro";
import CommentForm from "./CommentForm.astro";
import CommentReplies from "./CommentReplies.astro";
import type { CommentWithProfile } from "../../lib/types/comments";

const { articleId, postSlug, postTitle } = Astro.props;

// Canonical slug used everywhere
const articleSlug = String(postSlug || articleId || "").replace(/\/+$/, "");

// **UPDATED: Use comments strategy**
const WRITE_ENVIRONMENT = getCommentsWriteEnvironment();
const READ_ENVIRONMENTS = getCommentsReadEnvironments();

console.log(
  `üîß Config - Write: ${WRITE_ENVIRONMENT}, Read: [${READ_ENVIRONMENTS.join(", ")}]`
);

const currentUser = null;

interface ArticleAuthor {
  slug: string;
  name: string;
  bio: string | null;
  avatar: string | null;
  is_verified: boolean;
  role: string | null;
  company: string | null;
}

interface ArticleWithAuthor {
  slug: string;
  title: string;
  author_id: string;
  authors: ArticleAuthor | null;
}

let articleWithAuthor: ArticleWithAuthor | null = null;
let totalRootComments = 0;
let allComments: CommentWithProfile[] = [];
const COMMENTS_PER_PAGE = COMMENT_CONFIG.pageSize || 5;

// Fetch article with author information
try {
  const { data: articleData, error: articleError } = await supabase
    .from("articles")
    .select(
      `
      slug, title, author_id,
      authors:authors!articles_author_id_fkey(slug, name, bio, avatar, is_verified, role, company)
    `
    )
    .eq("slug", articleSlug)
    .single();

  if (!articleError && articleData) {
    articleWithAuthor = {
      slug: articleData.slug,
      title: articleData.title,
      author_id: articleData.author_id,
      authors: Array.isArray(articleData.authors)
        ? articleData.authors[0] || null
        : articleData.authors || null,
    } as ArticleWithAuthor;
  }
} catch (error) {
  console.error("‚ùå Error loading article author:", error);
}

// **UPDATED: Multi-environment comment fetching**
try {
  let foundComments = false;
  let selectedEnvironment = "";

  // Try each environment in order (production first)
  for (const env of READ_ENVIRONMENTS) {
    console.log(`üîç Trying environment: ${env} for article: ${articleSlug}`);

    const { count: rootCount, error: countError } = await supabase
      .from("comments")
      .select("id", { count: "exact", head: true })
      .eq("article_id", articleSlug)
      .eq("is_deleted", false)
      .eq("environment", env)
      .in("moderation_status", ["approved", "auto_approved"])
      .is("parent_id", null);

    // Fix: Handle null rootCount
    const safeRootCount = rootCount ?? 0;
    console.log(
      `üìä Environment ${env}: count=${safeRootCount}, error=${countError?.message || "none"}`
    );

    if (!countError && safeRootCount > 0) {
      console.log(`‚úÖ Found ${safeRootCount} comments in ${env}`);
      totalRootComments = safeRootCount; // Fix: Use safeRootCount instead of rootCount
      selectedEnvironment = env;
      foundComments = true;
      break;
    }
  }

  if (foundComments && totalRootComments > 0) {
    console.log(
      `üéØ Using environment: ${selectedEnvironment} for data fetching`
    );

    // Rest of your code stays the same...
    const { data: rootCommentsData, error: rootError } = await supabase
      .from("comments")
      .select(
        `
        id, article_id, user_id, parent_id, content,
        is_edited, is_deleted, like_count, created_at, updated_at, thread_level,
        moderation_status, deleted_at, deleted_by, is_pinned, quality_score, mention_users
      `
      )
      .eq("article_id", articleSlug)
      .eq("is_deleted", false)
      .eq("environment", selectedEnvironment)
      .in("moderation_status", ["approved", "auto_approved"])
      .is("parent_id", null)
      .order("created_at", { ascending: false });

    // Continue with the rest of your existing code...
    if (rootError) {
      console.error("Error fetching root comments:", rootError);
    } else if (rootCommentsData?.length) {
      const rootIds = rootCommentsData.map((c) => c.id);
      console.log(`üìù Fetched ${rootCommentsData.length} root comments`);

      // Fetch replies from same environment
      const { data: repliesData, error: repliesError } = await supabase
        .from("comments")
        .select(
          `
          id, article_id, user_id, parent_id, content,
          is_edited, is_deleted, like_count, created_at, updated_at, thread_level,
          moderation_status, deleted_at, deleted_by, is_pinned, quality_score, mention_users
        `
        )
        .in("parent_id", rootIds)
        .eq("is_deleted", false)
        .eq("environment", selectedEnvironment)
        .in("moderation_status", ["approved", "auto_approved"])
        .order("created_at", { ascending: true });

      if (repliesError) {
        console.error("Error fetching replies:", repliesError);
      } else {
        console.log(`üí¨ Fetched ${repliesData?.length || 0} replies`);
      }

      allComments = [
        ...rootCommentsData,
        ...(repliesData || []),
      ] as CommentWithProfile[];

      // **FIXED: Profile fetching without environment filter**
      const userIds = [
        ...new Set(
          allComments.map((c) => c.user_id).filter(Boolean) as string[]
        ),
      ];

      let profilesData: any[] | null = null;
      if (userIds.length > 0) {
        console.log(`üë• Fetching profiles for ${userIds.length} users`);

        // Try without environment filter first (most profiles don't have environment column)
        const { data: profiles, error: profileError } = await supabase
          .from("profiles")
          .select(
            `
            id, display_name, avatar_type, avatar_preset_id, avatar_url,
            reputation_score, is_admin, membership_type
          `
          )
          .in("id", userIds);

        if (profiles?.length) {
          profilesData = profiles;
          console.log(
            `‚úÖ Found ${profiles.length} profiles (no environment filter)`
          );
        } else if (profileError) {
          console.warn("Profile fetch error:", profileError);
        }
      }

      // **UPDATED: Interactions with same environment as comments**
      const allCommentIds = allComments.map((c) => c.id);
      console.log(
        `üîó Fetching interactions for ${allCommentIds.length} comments`
      );

      const [reactions, likes, bookmarks] = await Promise.all([
        supabase
          .from("comment_reactions")
          .select("comment_id, reaction_type, user_id")
          .in("comment_id", allCommentIds)
          .eq("environment", selectedEnvironment),
        supabase
          .from("comment_likes")
          .select("comment_id, user_id")
          .in("comment_id", allCommentIds)
          .eq("environment", selectedEnvironment),
        supabase
          .from("comment_bookmarks")
          .select("comment_id, user_id")
          .in("comment_id", allCommentIds)
          .eq("environment", selectedEnvironment),
      ]);

      console.log(
        `üìä Interactions - Reactions: ${reactions.data?.length || 0}, Likes: ${likes.data?.length || 0}, Bookmarks: ${bookmarks.data?.length || 0}`
      );

      // Normalize comments with profile and interaction data
      allComments = allComments.map((comment) => {
        const profile = profilesData?.find((p) => p.id === comment.user_id);
        const commentReactions =
          reactions.data?.filter((r) => r.comment_id === comment.id) || [];
        const commentLikes =
          likes.data?.filter((l) => l.comment_id === comment.id) || [];
        const commentBookmarks =
          bookmarks.data?.filter((b) => b.comment_id === comment.id) || [];

        return {
          ...comment,
          // Ensure all required fields are present
          thread_level: comment.thread_level ?? 0,
          status: comment.moderation_status || "approved",
          moderation_status: comment.moderation_status || "approved",
          like_count: comment.like_count || 0,
          is_edited: comment.is_edited || false,
          is_deleted: comment.is_deleted || false,

          // Profile data
          profiles: profile
            ? {
                id: profile.id,
                display_name: profile.display_name,
                avatar_type: profile.avatar_type || "preset",
                avatar_preset_id: profile.avatar_preset_id || 1,
                avatar_url: profile.avatar_url,
                reputation_score: profile.reputation_score || 0,
                is_admin: profile.is_admin || false,
              }
            : null,

          user_profile: profile || null,

          // Interaction data
          comment_reactions: commentReactions,
          comment_likes: commentLikes,
          comment_bookmarks: commentBookmarks,

          // Computed fields
          reaction_counts: commentReactions.reduce(
            (acc, reaction) => {
              acc[reaction.reaction_type] =
                (acc[reaction.reaction_type] || 0) + 1;
              return acc;
            },
            {} as Record<string, number>
          ),

          // Tree structure
          replies: [],
          reply_count: 0,

          // User interaction states (will be updated on client-side)
          is_comment_liked: false,
          is_comment_saved: false,
          is_comment_bookmarked: false,
          is_liked: false,
          is_saved: false,
          is_bookmarked: false,

          // Computed permissions (will be updated on client-side)
          can_edit: false,
          can_delete: false,
          can_reply: true,
        } as CommentWithProfile;
      });
    }
  } else {
    console.log(
      `üì≠ No comments found in any environment for article: ${articleSlug}`
    );
  }
} catch (error) {
  console.error("Failed to load comments:", error);
  allComments = [];
  totalRootComments = 0;
}

// Build comment tree
const fullCommentTree = buildCommentTree(allComments);
console.log(
  `üå≥ Built comment tree with ${fullCommentTree.length} root comments`
);

// Get initial comments for display
const initialDisplayComments = fullCommentTree.slice(0, COMMENTS_PER_PAGE);
const loadedRootComments = initialDisplayComments.length;

// Prepare reaction types for client-side
const reactionTypes = Object.entries(REACTION_TYPES).map(([name, value]) => ({
  name,
  emoji: value.emoji,
  label: value.label,
}));
---

<section
  class="tinkbyte-comment-section"
  id="comments-section"
  data-article-id={articleSlug}
  data-environment={WRITE_ENVIRONMENT}
  data-config={JSON.stringify(COMMENT_CONFIG)}
  data-total-comments={totalRootComments}
  data-loaded-comments={loadedRootComments}
  data-comments-per-page={COMMENTS_PER_PAGE}
  data-reaction-types={JSON.stringify(reactionTypes)}
>
  <!-- Thread Header -->
  <div class="thread-header">
    <div class="thread-header-content">
      <div class="thread-info">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
          ></path>
        </svg>
        <span class="thread-label">THREAD</span>
        <span class="thread-count" id="total-comments">{totalRootComments}</span
        >
      </div>
      <div class="header-actions">
        <button class="manage-btn" id="tinkbyte-account-btn">
          Manage Your <span class="highlight">TINKBYTE</span> Account
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </button>
      </div>
    </div>
    <div class="thread-subtitle">
      We want to hear from you! Share your opinions in the thread below and
      remember to keep it respectful.
    </div>
  </div>

  <!-- Comment Form Section -->
  <div class="comment-form-section" id="comment-form-section">
    <div class="guest-comment-prompt" id="guest-comment-prompt">
      <div class="guest-avatar">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </div>
      <div class="guest-prompt-content">
        <input
          type="text"
          class="guest-comment-input"
          placeholder="Share your thoughts"
          readonly
          onclick="window.location.href='/auth/signin'"
        />
        <div class="guest-prompt-text">
          <a href="/auth/signin" class="auth-link">Sign in</a> to join the conversation
        </div>
      </div>
    </div>
    <div
      class="user-comment-form"
      id="user-comment-form"
      style="display: none;"
    >
      <CommentForm articleId={articleSlug} />
    </div>
  </div>

  <!-- Sort Options -->
  <div class="sort-section">
    <div class="sort-controls">
      <label for="sort-select">Sort by:</label>
      <select id="sort-select" class="sort-select">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="popular">Popular</option>
      </select>
    </div>
  </div>

  <!-- Comments Container -->
  <div class="comments-container" id="comments-container">
    {
      totalRootComments === 0 ? (
        <div class="empty-state" id="empty-state">
          <div class="empty-content">
            <div class="empty-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
              </svg>
            </div>
            <h3 class="empty-title">No comments yet</h3>
            <p class="empty-description">
              Be the first to share your thoughts on this article.
            </p>
          </div>
        </div>
      ) : (
        <div class="comments-list" id="comments-list">
          <div class="comments-items" id="comments-items">
            {initialDisplayComments.map((comment) => (
              <div class="comment-wrapper" data-comment-id={comment.id}>
                <CommentCard
                  comment={comment}
                  currentUserId={undefined}
                  reactionTypes={reactionTypes}
                  isReply={false}
                />
                <div class="inline-reply-container" style="display: none;" />
                <div class="inline-edit-container" style="display: none;" />
                {comment.replies && comment.replies.length > 0 && (
                  <CommentReplies
                    replies={comment.replies}
                    currentUserId={undefined}
                    reactionTypes={reactionTypes}
                    maxDepth={4}
                  />
                )}
              </div>
            ))}
          </div>
        </div>
      )
    }
  </div>
</section>

<!-- Load More Section -->
<div
  class="load-more-section"
  id="load-more-section"
  style={loadedRootComments >= totalRootComments
    ? "display: none;"
    : "display: block;"}
>
  <div class="load-more-container">
    <div class="load-more-info">
      <span class="showing-count">
        Showing <span id="showing-count">{loadedRootComments}</span> of
        <span id="total-count">{totalRootComments}</span> comments
      </span>
    </div>
    <button class="load-more-btn" id="load-more-btn" type="button">
      <span class="btn-text">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="6,9 12,15 18,9"></polyline>
        </svg>
        Load More Comments
      </span>
      <div class="btn-spinner" style="display: none;">
        <div class="loading-spinner"></div>
      </div>
    </button>
  </div>
</div>

<!-- Modals and Templates (keeping your existing ones) -->
<!-- Delete Modal -->
<div id="delete-modal" class="modal-overlay" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <h3>Delete Comment</h3>
      <button class="modal-close" type="button" id="close-delete-modal"
        >&times;</button
      >
    </div>
    <div class="modal-body">
      <p>
        Are you sure you want to delete this comment? This action cannot be
        undone.
      </p>
      <div class="comment-preview" id="delete-comment-preview"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" type="button" id="cancel-delete"
        >Cancel</button
      >
      <button class="btn-danger" type="button" id="confirm-delete">
        <span class="btn-text">Delete Comment</span>
        <div class="btn-spinner" style="display: none;">
          <div class="loading-spinner"></div>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div id="report-modal" class="modal-overlay" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <h3>Report Comment</h3>
      <button class="modal-close" type="button" id="close-report-modal"
        >&times;</button
      >
    </div>
    <div class="modal-body">
      <p>Why are you reporting this comment?</p>
      <div class="report-reasons">
        <label class="report-reason">
          <input type="radio" name="report-reason" value="spam" />
          <span>Spam or promotional content</span>
        </label>
        <label class="report-reason">
          <input type="radio" name="report-reason" value="harassment" />
          <span>Harassment or bullying</span>
        </label>
        <label class="report-reason">
          <input type="radio" name="report-reason" value="inappropriate" />
          <span>Inappropriate content</span>
        </label>
        <label class="report-reason">
          <input type="radio" name="report-reason" value="misinformation" />
          <span>Misinformation</span>
        </label>
        <label class="report-reason">
          <input type="radio" name="report-reason" value="other" />
          <span>Other</span>
        </label>
      </div>
      <textarea
        id="report-details"
        placeholder="Additional details (optional)"
        rows="3"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" type="button" id="cancel-report"
        >Cancel</button
      >
      <button class="btn-danger" type="button" id="confirm-report">
        <span class="btn-text">Report Comment</span>
        <div class="btn-spinner" style="display: none;">
          <div class="loading-spinner"></div>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- Templates (keeping your existing templates) -->
<!-- Inline Reply Template -->
<template id="inline-reply-template">
  <div class="inline-reply-form">
    <div class="reply-form-header">
      <div class="reply-context-info">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="9,17 4,12 9,7"></polyline>
          <path d="M20 18v-2a4 4 0 0 0-4-4H4"></path>
        </svg>
        <span>Replying to <strong class="reply-author-name"></strong></span>
      </div>
      <button type="button" class="cancel-inline-reply">√ó</button>
    </div>
    <form class="inline-comment-form">
      <div class="inline-user-info">
        <div class="inline-user-avatar"></div>
        <div class="inline-user-name"></div>
      </div>
      <div class="inline-content-section">
        <div class="inline-formatting-toolbar">
          <div class="inline-format-buttons">
            <button type="button" class="inline-format-btn" data-format="bold">
              <strong>B</strong>
            </button>
            <button
              type="button"
              class="inline-format-btn"
              data-format="italic"
            >
              <em>I</em>
            </button>
            <button type="button" class="inline-format-btn" data-format="code">
              <code>&lt;/&gt;</code>
            </button>
            <button type="button" class="inline-emoji-btn">
              <span>üòä</span>
            </button>
          </div>
          <div class="inline-char-count">
            <span class="count">0</span>/{COMMENT_CONFIG.characterLimits.max}
          </div>
        </div>
        <div class="inline-emoji-picker">
          <div class="emoji-grid">
            <button type="button" class="emoji-option" data-emoji="üòä"
              >üòä</button
            >
            <button type="button" class="emoji-option" data-emoji="üòÇ"
              >üòÇ</button
            >
            <button type="button" class="emoji-option" data-emoji="üòç"
              >üòç</button
            >
            <button type="button" class="emoji-option" data-emoji="ü§î"
              >ü§î</button
            >
            <button type="button" class="emoji-option" data-emoji="üëç"
              >üëç</button
            >
            <button type="button" class="emoji-option" data-emoji="üëé"
              >üëé</button
            >
            <button type="button" class="emoji-option" data-emoji="‚ù§Ô∏è"
              >‚ù§Ô∏è</button
            >
            <button type="button" class="emoji-option" data-emoji="üî•"
              >üî•</button
            >
            <button type="button" class="emoji-option" data-emoji="üí°"
              >üí°</button
            >
            <button type="button" class="emoji-option" data-emoji="üéâ"
              >üéâ</button
            >
            <button type="button" class="emoji-option" data-emoji="‚ö°"
              >‚ö°</button
            >
            <button type="button" class="emoji-option" data-emoji="‚ú®"
              >‚ú®</button
            >
          </div>
        </div>
        <textarea
          name="content"
          placeholder="Write your reply..."
          rows="3"
          maxlength={COMMENT_CONFIG.characterLimits.max}
          required
          class="inline-textarea"></textarea>
        <div class="inline-form-footer">
          <div class="inline-guidelines">
            Please respect our community guidelines.
          </div>
          <div class="inline-actions">
            <button type="button" class="cancel-inline-btn">Cancel</button>
            <button type="submit" class="submit-inline-btn">
              <span class="btn-text">Reply</span>
              <div class="btn-spinner" style="display: none;">
                <div class="loading-spinner"></div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</template>

<!-- Inline Edit Template -->
<template id="inline-edit-template">
  <div class="inline-edit-form">
    <div class="edit-form-header">
      <span>Edit Comment</span>
      <button type="button" class="cancel-edit-inline">√ó</button>
    </div>
    <form class="edit-comment-form-inline">
      <div class="edit-formatting-toolbar">
        <div class="edit-format-buttons">
          <button type="button" class="edit-format-btn" data-format="bold">
            <strong>B</strong>
          </button>
          <button type="button" class="edit-format-btn" data-format="italic">
            <em>I</em>
          </button>
          <button type="button" class="edit-format-btn" data-format="code">
            <code>&lt;/&gt;</code>
          </button>
        </div>
        <div class="edit-char-count">
          <span class="count">0</span>/{COMMENT_CONFIG.characterLimits.max}
        </div>
      </div>
      <textarea
        name="content"
        placeholder="Edit your comment..."
        rows="4"
        maxlength={COMMENT_CONFIG.characterLimits.max}
        required
        class="edit-textarea"></textarea>
      <div class="edit-form-footer">
        <select class="edit-reason-select" name="edit_reason">
          <option value="">Select edit reason</option>
          {
            COMMENT_CONFIG.editReasons.map((reason) => (
              <option value={reason}>{reason}</option>
            ))
          }
        </select>
        <div class="edit-actions">
          <button type="button" class="cancel-edit-btn">Cancel</button>
          <button type="submit" class="save-edit-btn">
            <span class="btn-text">Save Changes</span>
            <div class="btn-spinner" style="display: none;">
              <div class="loading-spinner"></div>
            </div>
          </button>
        </div>
      </div>
    </form>
  </div>
</template>


<!-- Debug: Server-side data -->
<script is:inline define:vars={{
  commentTreeLength: fullCommentTree.length,
  totalComments: totalRootComments,
  firstComment: fullCommentTree[0]?.id || 'none'
}}>
  console.log('üö® SSR BUILD DATA:', {
    commentTreeLength,
    totalComments,
    firstComment,
    articleSlug: document.getElementById('comments-section')?.dataset?.articleId
  });
</script>

{
  fullCommentTree.length > 0 && (
    <script
      type="application/json"
      id="tink-comments-data"
      set:html={JSON.stringify(fullCommentTree)}
    />
  )
}

<!-- Fallback empty array if no comments -->
{
  fullCommentTree.length === 0 && (
    <script type="application/json" id="tink-comments-data">
      []
    </script>
  )
}

<style is:global>
  @import "../../styles/comments.css";
</style>

<script is:inline>
  document.addEventListener("DOMContentLoaded", async function () {
    const config = window.TINKBYTE_CONFIG;
    const isDev = config?.isDevelopment || false;

    console.log("üîç DOM loaded, checking for required modules...");

    try {
      let attempts = 0;
      const maxAttempts = 200;

      // Wait for required modules to load
      while (
        (!window.supabase || !window.TinkByteAPI) &&
        attempts < maxAttempts
      ) {
        await new Promise((resolve) => setTimeout(resolve, 50));
        attempts++;
      }

      if (!window.supabase || !window.TinkByteAPI) {
        throw new Error("Required modules not loaded after maximum attempts");
      }

      console.log("‚úÖ Required modules loaded");

      // Additional delay for auth system to be ready
      await new Promise((resolve) => setTimeout(resolve, 500));

      // Dispatch auth ready event
      window.dispatchEvent(
        new CustomEvent("authReady", {
          detail: {
            authManager: window.authManager,
            supabase: window.supabase,
            TinkByteAPI: window.TinkByteAPI,
          },
        })
      );
    } catch (error) {
      console.error("Comment initialization failed:", error);

      // Show fallback UI
      const commentSection = document.getElementById("comments-section");
      if (commentSection) {
        commentSection.innerHTML = `
          <div style="padding: 2rem; text-align: center; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; margin: 1rem 0;">
            <h3 style="color: #dc2626; margin-bottom: 0.5rem;">Comments Temporarily Unavailable</h3>
            <p style="color: #991b1b; margin-bottom: 1rem;">Please refresh the page or try again later.</p>
            <button onclick="window.location.reload()" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
              Retry
            </button>
          </div>
        `;
      }
    }
  });
</script>

<script src="/scripts/comments.js" is:inline></script>
